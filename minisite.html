<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>The Grove Incident | Invite Unlock</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Instrument+Serif:ital@0;1&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  :root {
    --bg-1: #0f1216;
    --bg-2: #1e1b17;
    --ink: #efe3c5;
    --ink-dim: #a58f68;
    --gold: #e4b85f;
    --gold-strong: #f2c76b;
    --line: #3a3021;
    --danger: #b04f4f;
    --ok: #7ab78a;
  }

  html, body {
    min-height: 100%;
    background: radial-gradient(circle at 15% 15%, #2a2417 0%, transparent 45%),
      radial-gradient(circle at 80% 70%, #182129 0%, transparent 50%),
      linear-gradient(150deg, var(--bg-1), var(--bg-2));
    color: var(--ink);
    font-family: 'Space Grotesk', sans-serif;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    pointer-events: none;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 250 250' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='0.9' numOctaves='2'/%3E%3C/filter%3E%3Crect width='250' height='250' filter='url(%23n)' opacity='0.06'/%3E%3C/svg%3E");
    opacity: 0.5;
  }

  .wrap {
    width: min(860px, 92vw);
    margin: 0 auto;
    padding: 24px 0 42px;
  }

  .screen {
    display: none;
    animation: rise 0.45s ease both;
  }

  .screen.active {
    display: block;
  }

  .panel {
    background: rgba(12, 14, 18, 0.82);
    border: 1px solid var(--line);
    padding: 28px;
    position: relative;
    backdrop-filter: blur(4px);
  }

  .panel::before {
    content: '';
    position: absolute;
    inset: 10px;
    border: 1px solid rgba(228, 184, 95, 0.12);
    pointer-events: none;
  }

  .eyebrow {
    font-size: 11px;
    letter-spacing: 0.2em;
    color: var(--ink-dim);
    text-transform: uppercase;
  }

  .title {
    margin-top: 10px;
    font-family: 'Bebas Neue', sans-serif;
    letter-spacing: 0.03em;
    font-size: clamp(48px, 12vw, 96px);
    line-height: 0.9;
    color: var(--gold-strong);
  }

  .subtitle {
    margin-top: 4px;
    font-family: 'Instrument Serif', serif;
    font-style: italic;
    font-size: clamp(24px, 4vw, 36px);
    color: var(--ink);
  }

  .body-copy {
    margin-top: 24px;
    font-size: 16px;
    line-height: 1.75;
    color: #cfbf9d;
    max-width: 650px;
  }

  .grid {
    margin-top: 24px;
    display: grid;
    gap: 14px;
  }

  .grid.two {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  label {
    display: block;
    font-size: 11px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--ink-dim);
    margin-bottom: 8px;
  }

  input, select, textarea {
    width: 100%;
    border: 1px solid #4a3e2b;
    background: rgba(5, 6, 8, 0.9);
    color: var(--ink);
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    font-family: 'Space Grotesk', sans-serif;
    outline: none;
  }

  textarea {
    min-height: 90px;
    resize: vertical;
  }

  .witty-badge {
    margin-top: 14px;
    display: inline-block;
    border: 1px dashed #5d4d34;
    color: #ccb48b;
    font-size: 12px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 7px 10px;
    background: rgba(228, 184, 95, 0.06);
  }

  .field-note {
    margin-top: 7px;
    color: #9a845c;
    font-size: 12px;
    line-height: 1.5;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--gold);
    box-shadow: 0 0 0 2px rgba(228, 184, 95, 0.15);
  }

  .actions {
    margin-top: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  button, .btn-link {
    appearance: none;
    border: 1px solid var(--gold);
    background: var(--gold);
    color: #111;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 12px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-weight: 700;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  button.ghost, .btn-link.ghost {
    background: transparent;
    color: var(--gold);
  }

  .note {
    margin-top: 12px;
    font-size: 13px;
    color: var(--ink-dim);
    line-height: 1.6;
  }

  .error {
    margin-top: 12px;
    color: var(--danger);
    font-size: 13px;
    display: none;
  }

  .ok {
    margin-top: 12px;
    color: var(--ok);
    font-size: 13px;
    display: none;
  }

  .game-shell {
    margin-top: 22px;
    border: 1px solid #3d3122;
    border-radius: 12px;
    overflow: hidden;
    background: #090a0c;
  }

  .game-hud {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 8px 14px;
    padding: 10px 14px;
    background: #141920;
    border-bottom: 1px solid #2f3a4b;
    font-size: 12px;
    color: #d2c19f;
  }

  canvas {
    display: block;
    width: 100%;
    height: auto;
    background: linear-gradient(180deg, #1a1f28, #11161d 55%, #1d1914 55%, #1a120a);
    touch-action: manipulation;
  }

  .game-help {
    padding: 12px 14px;
    border-top: 1px solid #2c261d;
    font-size: 13px;
    color: #bfa67b;
  }

  .status {
    margin-top: 14px;
    min-height: 22px;
    font-size: 14px;
    color: #d3c4a3;
  }

  .jump-wrap {
    display: none;
    margin-top: 12px;
  }

  .mobile-jump {
    width: 100%;
    min-height: 54px;
    border-radius: 12px;
    font-size: 14px;
    letter-spacing: 0.08em;
  }

  .dossier {
    margin-top: 22px;
    border: 1px solid #3f3425;
    padding: 22px;
    background: #111319;
  }

  .dossier-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(40px, 7vw, 64px);
    line-height: 0.92;
    color: var(--gold-strong);
    letter-spacing: 0.03em;
  }

  .dossier-sub {
    margin-top: 6px;
    font-family: 'Instrument Serif', serif;
    font-style: italic;
    color: #d7c7a4;
    font-size: 22px;
  }

  .meta {
    margin-top: 8px;
    color: #9f8b67;
    font-size: 14px;
  }

  .card-grid {
    margin-top: 20px;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
  }

  .card {
    border: 1px solid #3a2f20;
    background: rgba(228, 184, 95, 0.05);
    padding: 14px;
  }

  .card h4 {
    font-size: 11px;
    letter-spacing: 0.14em;
    color: #d2b06b;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .card p {
    font-size: 14px;
    line-height: 1.6;
    color: #e5d6b7;
  }

  .event-strip {
    margin-top: 18px;
    border: 1px solid #332a1e;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 1px;
    background: #302619;
  }

  .event-cell {
    background: #121317;
    padding: 12px;
  }

  .event-cell .k {
    font-size: 11px;
    letter-spacing: 0.12em;
    color: #987f57;
    text-transform: uppercase;
  }

  .event-cell .v {
    margin-top: 4px;
    color: #f0e0bf;
    line-height: 1.55;
    font-size: 14px;
  }

  .loader {
    margin-top: 28px;
    text-align: center;
  }

  .dots {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 14px;
  }

  .dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--gold);
    animation: pulse 1.2s infinite ease;
  }

  .dots span:nth-child(2) { animation-delay: 0.15s; }
  .dots span:nth-child(3) { animation-delay: 0.3s; }

  @keyframes pulse {
    0%, 100% { transform: scale(0.75); opacity: 0.35; }
    50% { transform: scale(1); opacity: 1; }
  }

  @keyframes rise {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 760px) {
    .panel { padding: 20px; }
    .grid.two, .card-grid, .event-strip { grid-template-columns: 1fr; }
    .title { font-size: clamp(52px, 18vw, 82px); }
    .subtitle { font-size: 26px; }
    .jump-wrap { display: block; }
  }
</style>
</head>
<body>
<div class="wrap">

  <section id="screen-landing" class="screen active">
    <div class="panel">
      <div class="eyebrow">Confidential Invite • The Grove A7</div>
      <h1 class="title">THE GROVE</h1>
      <div class="subtitle">Signal & Noise</div>
      <p class="body-copy">
        This invite is interactive. Your dossier only unlocks if you finish a short 27-year run:
        nursery, school, exams, college, jobs, deadlines, and rent. Survive to age 27 and the case file opens.
      </p>
      <div class="actions">
        <button id="start-btn">Start Invite Unlock</button>
      </div>
      <p class="note">Party date: Sunday, 1 March 2026 • Doors 5:00 PM • Story begins 8:00 PM</p>
    </div>
  </section>

  <section id="screen-profile" class="screen">
    <div class="panel">
      <div class="eyebrow">Step 1 • Identity</div>
      <h2 class="subtitle">Give me your best suspicious profile</h2>
      <div class="witty-badge">Fast answers only. Overthinking is evidence.</div>

      <div class="grid">
        <div>
          <label for="name-input">First name (as on Aadhaar) *</label>
          <input id="name-input" type="text" placeholder="Write your first name. Role already assigned." autocomplete="given-name" />
          <p class="field-note">Use your real first name if possible. We have already mapped your role.</p>
        </div>
        <div>
          <label for="vibe-input">Your operating mode tonight</label>
          <select id="vibe-input">
            <option value="balanced">Diplomatic chaos: both floors</option>
            <option value="anthem">Main floor headline energy</option>
            <option value="after-hours">After-hours tunnel vision</option>
            <option value="floating">Roaming auditor of bad decisions</option>
          </select>
          <p class="field-note">This changes your dossier tone and mission task.</p>
        </div>
        <div>
          <label for="adjective-input">One adjective for your game name</label>
          <input id="adjective-input" type="text" placeholder="Example: hostile, fearless, chaotic" />
          <p class="field-note">If you write `hostile` and your name is Bharat, you become `Hostile Bharat`.</p>
        </div>
        <div>
          <label for="lore-input">One chaotic life checkpoint (optional)</label>
          <textarea id="lore-input" placeholder="Example: Cracked exams, survived startups, still argues in docs at 2 AM."></textarea>
        </div>
      </div>

      <div class="actions">
        <button id="to-game-btn">Lock This Profile</button>
        <button class="ghost" id="back-to-landing-btn">Back</button>
      </div>
      <p class="error" id="profile-error"></p>
    </div>
  </section>

  <section id="screen-game" class="screen">
    <div class="panel">
      <div class="eyebrow">Step 2 • Unlock Run</div>
      <h2 class="subtitle">Age Runner: Reach 27</h2>
      <p class="note">Mario mode. Jump over bullies, teachers, coaching monsters and exam traps. Collect extracurricular boosts for extra lives. Desktop: `Space`, Mobile: tap or use Jump button.</p>

      <div class="game-shell">
        <div class="game-hud">
          <span id="hud-age">Age: 0</span>
          <span id="hud-distance">Progress: 0%</span>
          <span id="hud-stage">Stage: Nursery</span>
          <span id="hud-lives">Lives: 5</span>
        </div>
        <canvas id="runner-canvas" width="760" height="240"></canvas>
        <div class="game-help">Enemies: bullies, teachers, coaching tutors. Traps: exams, deadlines, rent. Boosts: sports/debate/fest wins for extra lives.</div>
      </div>

      <div class="status" id="game-status">Press start when ready.</div>
      <div class="actions">
        <button id="game-start-btn">Start Run</button>
        <button class="ghost" id="game-reset-btn">Reset</button>
        <button class="ghost" id="game-back-btn">Edit Profile</button>
      </div>
      <div class="jump-wrap">
        <button id="mobile-jump-btn" class="mobile-jump">Jump</button>
      </div>
    </div>
  </section>

  <section id="screen-loading" class="screen">
    <div class="panel loader">
      <div class="eyebrow">Step 3 • Character Dossier</div>
      <h2 class="subtitle">Generating your character card...</h2>
      <p class="note" id="loading-msg">Matching guest roster and assignments</p>
      <div class="dots"><span></span><span></span><span></span></div>
    </div>
  </section>

  <section id="screen-character" class="screen">
    <div class="panel">
      <div class="eyebrow">Unlocked • Invitee Dossier</div>
      <div class="dossier">
        <h2 class="dossier-title" id="char-alias">The Placeholder</h2>
        <div class="dossier-sub" id="char-name">Name</div>
        <div class="meta" id="char-role">Role</div>

        <div class="card-grid">
          <div class="card">
            <h4>Bio</h4>
            <p id="char-bio"></p>
          </div>
          <div class="card">
            <h4>Motive</h4>
            <p id="char-motive"></p>
          </div>
          <div class="card">
            <h4>Secret</h4>
            <p id="char-secret"></p>
          </div>
          <div class="card">
            <h4>Clue</h4>
            <p id="char-clue"></p>
          </div>
          <div class="card">
            <h4>Special Ability (Use In Game)</h4>
            <p id="char-superpower"></p>
          </div>
          <div class="card">
            <h4>Live Mission Task</h4>
            <p id="char-task"></p>
          </div>
        </div>

        <div class="card" style="margin-top: 12px;">
          <h4>Drinking Cue</h4>
          <p id="char-drink"></p>
        </div>

        <div class="event-strip">
          <div class="event-cell">
            <div class="k">Date</div>
            <div class="v">Sunday, 1 March 2026</div>
          </div>
          <div class="event-cell">
            <div class="k">Doors</div>
            <div class="v">5:00 PM</div>
          </div>
          <div class="event-cell">
            <div class="k">Story Time</div>
            <div class="v">8:00 PM sharp</div>
          </div>
          <div class="event-cell">
            <div class="k">Venue</div>
            <div class="v">The Grove, A7, Sarjapur Road</div>
          </div>
          <div class="event-cell">
            <div class="k">Lower Hall</div>
            <div class="v">House Pot & Bar</div>
          </div>
          <div class="event-cell">
            <div class="k">Upper Hall</div>
            <div class="v">After Hours Hall</div>
          </div>
        </div>

        <div class="card" style="margin-top: 12px;">
          <h4>Case Prelude</h4>
          <p id="story-synopsis-1"></p>
          <p id="story-synopsis-2" style="margin-top: 10px;"></p>
        </div>
      </div>

      <div class="actions">
        <a id="rsvp-btn" class="btn-link" target="_blank" rel="noopener noreferrer">RSVP Now</a>
        <button id="rsvp-submit-btn">Submit RSVP to Sheet</button>
        <button class="ghost" id="regen-btn">Shuffle Character Angle</button>
        <button class="ghost" id="replay-btn">Replay Unlock</button>
      </div>
      <div class="grid two">
        <div>
          <label for="rsvp-status">RSVP status</label>
          <select id="rsvp-status">
            <option value="Yes">Yes, in by 8</option>
            <option value="Late">Late, but dramatic</option>
            <option value="Maybe">Maybe, depends on traffic and excuses</option>
          </select>
        </div>
        <div>
          <label for="rsvp-eta">Expected arrival time</label>
          <input id="rsvp-eta" type="text" placeholder="Example: 8:30 PM" />
        </div>
      </div>
      <p class="note">House setup is available. BYOB is appreciated, especially after 8 PM.</p>
      <p class="error" id="api-error"></p>
      <p class="ok" id="rsvp-note">RSVP link ready. Your name and role are prefilled.</p>
    </div>
  </section>

</div>

<script src="./site-config.js"></script>
<script>
  const DEFAULT_CONFIG = {
    rsvpFormUrl: "https://docs.google.com/forms/d/e/REPLACE_FORM_ID/viewform",
    rsvpFormActionUrl: "https://docs.google.com/forms/d/e/REPLACE_FORM_ID/formResponse",
    rsvpFields: {
      name: "entry.111111111",
      role: "entry.222222222",
      alias: "entry.333333333",
      attendance: "entry.444444444",
      eta: "entry.555555555",
      superpower: "entry.666666666",
      task: "entry.777777777"
    },
    attendanceYesValue: "Yes"
  };

  const CONFIG = Object.assign({}, DEFAULT_CONFIG, window.APP_CONFIG || {});

  const GUEST_ROSTER = [
    { name: "Bharat Dhir", keywords: ["bharat", "dhir"], title: "Category Manager", trait: "social", archetype: "commercial" },
    { name: "Manasi Chansoria", keywords: ["manasi", "chansoria"], title: "Assistant Manager", trait: "energetic", archetype: "ops" },
    { name: "Ayush Mittal", keywords: ["ayush", "mittal"], title: "Data Engineer", trait: "shy", archetype: "data" },
    { name: "Shikhar Sharma", keywords: ["shikhar", "sharma"], title: "Data Scientist", trait: "charismatic", archetype: "data" },
    { name: "Shubh Khandelwal", keywords: ["shubh", "khandelwal"], title: "Product Lead", trait: "smart", archetype: "product" },
    { name: "Gunjan Samtani", keywords: ["gunjan", "samtani"], title: "Product Manager", trait: "social", archetype: "product" },
    { name: "Kartik Khandelwal", keywords: ["kartik", "khandelwal"], title: "Product Manager", trait: "proud", archetype: "product" },
    { name: "Pooja Ghatia", keywords: ["pooja", "ghatia"], title: "Product Manager", trait: "fun", archetype: "growth" },
    { name: "Aniket Chandra", keywords: ["aniket", "chandra"], title: "Finance", trait: "gym bro", archetype: "finance" },
    { name: "Vaibhav Gupta", keywords: ["vaibhav", "gupta"], title: "Tech", trait: "philosophical", archetype: "tech" },
    { name: "Varun Chopra", keywords: ["varun", "chopra"], title: "Product Manager", trait: "boxing bro", archetype: "product" },
    { name: "Pranjal Srivastava", keywords: ["pranjal", "srivastava"], title: "Singer", trait: "musician", archetype: "creative" },
    { name: "Aanak Sengupta", keywords: ["aanak", "sengupta"], title: "Product Manager", trait: "traveler", archetype: "product" },
    { name: "Padmanabhan Murli", keywords: ["padmanabhan", "murli"], title: "Tech", trait: "smart", archetype: "tech" },
    { name: "Mehul Mohan", keywords: ["mehul", "mohan"], title: "Founder", trait: "builder", archetype: "founder" },
    { name: "Siddak Bakshi", keywords: ["siddak", "bakshi"], title: "Crypto", trait: "founder", archetype: "crypto" },
    { name: "Neil Daftary", keywords: ["neil", "daftary"], title: "Crypto", trait: "deep guy", archetype: "crypto" },
    { name: "Devashish Rane", keywords: ["devashish", "rane"], title: "Product Manager", trait: "charismatic", archetype: "product" },
    { name: "Abhishek Gosavi", keywords: ["abhishek", "gosavi"], title: "Product Manager", trait: "sportsman", archetype: "product" },
    { name: "Vrishali", keywords: ["vrishali"], title: "Program Manager", trait: "fun", archetype: "ops" },
    { name: "Shaunak", keywords: ["shaunak"], title: "AI Founder", trait: "ai enthusiast", archetype: "ai" },
    { name: "Rahul", keywords: ["rahul"], title: "AI Founder", trait: "ai enthusiast", archetype: "ai" },
    { name: "Sarthak Dwivedi", keywords: ["sarthak", "dwivedi"], title: "Crypto Founder", trait: "networked", archetype: "crypto" },
    { name: "Ritvik Hedge", keywords: ["ritvik", "hedge"], title: "Product Manager", trait: "board game strategist", archetype: "product" },
    { name: "Mohnish Mhatre", keywords: ["mohnish", "mhatre"], title: "Product Manager", trait: "squash enthusiast", archetype: "product" },
    { name: "Harsh Bhimrajka", keywords: ["harsh", "bhimrajka"], title: "Security Tech", trait: "friendly", archetype: "security" },
    { name: "Sajag Jain", keywords: ["sajag", "jain"], title: "Business Analyst", trait: "friendly", archetype: "business" },
    { name: "Ayush Borse", keywords: ["borse"], title: "Product Manager", trait: "fixer", archetype: "product" },
    { name: "Aiswarya Mahajan", keywords: ["aiswarya", "mahajan"], title: "Designer", trait: "artist", archetype: "design" },
    { name: "Naren Kashyap", keywords: ["naren", "kashyap"], title: "Founder + DJ", trait: "hype", archetype: "founder" },
    { name: "Aishwarya Manjunath", keywords: ["aishwarya", "manjunath"], title: "Chief of Staff", trait: "all-rounder", archetype: "cos" },
    { name: "Shubham Jain", keywords: ["shubham", "jain"], title: "Data Scientist", trait: "sports nerd", archetype: "data" },
    { name: "Kovid Poudel", keywords: ["kovid", "poudel"], title: "Product + Tech", trait: "talented", archetype: "tech" },
    { name: "Anubhav Gaba", keywords: ["anubhav", "gaba"], title: "Product Manager", trait: "gaslighter", archetype: "product" },
    { name: "Naisargi Kothari", keywords: ["naisargi", "kothari"], title: "Business Manager", trait: "hard working", archetype: "business" },
    { name: "Srishti Malviya", keywords: ["srishti", "malviya"], title: "Product x Design", trait: "multi-hyphenate", archetype: "design" },
    { name: "Swapnil", keywords: ["swapnil"], title: "Product Manager", trait: "chill", archetype: "product" },
    { name: "Shrenik Golecha", keywords: ["shrenik", "golecha"], title: "Chief of Staff", trait: "vibrant", archetype: "cos" },
    { name: "Adarsh", keywords: ["adarsh"], title: "Neighbor Witness", trait: "mysterious", archetype: "wildcard" },
    { name: "Akshat", keywords: ["akshat"], title: "Finance", trait: "neighbor", archetype: "finance" }
  ];

  const ARCHETYPE_STYLE = {
    product: {
      aliases: ["Roadmap Whisperer", "Scope Negotiator", "Spec Gladiator"],
      motives: ["Their feature got cut but the blame stayed.", "They were promised ownership and got a 'nice doc'.", "Their timeline was rewritten in public."],
      secrets: ["They have an unsent escalation draft from launch week.", "They quietly changed priority tags before the board review.", "They know who approved the risky release."],
      clues: ["A color-coded backlog screenshot with private labels.", "A Slack thread exported at 2:11 AM.", "A Jira ticket that changed assignees three times."],
      drinks: ["Drink when someone says 'quick sync'.", "Drink when someone says 'let us align offline'.", "Drink when someone calls a delay 'minor'."]
    },
    data: {
      aliases: ["Metric Surgeon", "Dashboard Oracle", "Signal Miner"],
      motives: ["Their model was ignored when it predicted churn.", "They were asked to simplify numbers until they looked happy.", "They found anomalies that nobody wanted on slides."],
      secrets: ["They kept a shadow dashboard with real numbers.", "They ran one experiment nobody else has seen.", "They have a CSV with missing rows highlighted."],
      clues: ["A trendline screenshot that diverges post-launch.", "A notebook with commented-out guardrails.", "A query log timestamped right before the incident."],
      drinks: ["Drink when someone quotes data without sample size.", "Drink when someone says 'statistically vibes'.", "Drink when someone uses 'up and to the right' as evidence."]
    },
    finance: {
      aliases: ["Burn Rate Prophet", "Cap Table Sentry", "Ledger Handler"],
      motives: ["They flagged a cash risk that got buried.", "They were asked to relabel an expense trail.", "They saw a side letter nobody acknowledged."],
      secrets: ["They have a draft sheet with two different runway numbers.", "They know exactly who approved off-book movement.", "They froze one payment and never admitted it."],
      clues: ["A spreadsheet tab named 'actual_actual_final'.", "A transfer screenshot with a manual note.", "A bank export with one red-highlighted line item."],
      drinks: ["Drink when someone says 'it is just a small amount'.", "Drink when someone says 'budget is flexible'.", "Drink when someone says 'we can settle later'."]
    },
    crypto: {
      aliases: ["Wallet Cartographer", "Token Operator", "Chain Alchemist"],
      motives: ["They were blamed for volatility they predicted.", "They moved funds to protect them and got cornered.", "They saw treasury risk and nobody listened."],
      secrets: ["They can still recover one missing transaction path.", "They have a cold-wallet note written as poetry.", "They know whose wallet appeared in test logs."],
      clues: ["A wallet map drawn on a coaster.", "A hash note with one circled address.", "A screenshot of a transfer memo field."],
      drinks: ["Drink when someone says 'it is basically stable'.", "Drink when someone says 'on-chain proof incoming'.", "Drink when someone says 'trust me, gas was high'."]
    },
    ai: {
      aliases: ["Prompt Mechanic", "LLM Wrangler", "Hallucination Auditor"],
      motives: ["Their model warning was ignored before demo day.", "Their prompt stack was copied without credit.", "They were asked to call rules-engine output 'AI'."] ,
      secrets: ["They kept a private prompt changelog.", "They know when the guardrails were removed.", "They have the exact prompt that generated fake confidence."],
      clues: ["A prompt template titled 'demo-safe-final-v5'.", "A screenshot of temperature set too high.", "A markdown file with red-team notes."],
      drinks: ["Drink when someone says 'AI will handle it'.", "Drink when someone confuses automation with intelligence.", "Drink when someone calls a wrapper 'breakthrough'."]
    },
    design: {
      aliases: ["Interface Forensic", "Pixel Arbitrator", "Figma Defender"],
      motives: ["Their final design got overwritten minutes before launch.", "They were promised a seat in decisions and got post-facto edits.", "They watched user feedback get ignored for optics."],
      secrets: ["They kept snapshots of every unauthorized edit.", "They have a hidden component named 'please-stop'.", "They know who changed the main flow at 8:42 PM."],
      clues: ["A version history with suspicious edits.", "A design comment thread resolved too quickly.", "An export folder missing one critical screen."],
      drinks: ["Drink when someone says 'just make it pop'.", "Drink when someone asks for one tiny change.", "Drink when someone says 'design can fix it later'."]
    },
    security: {
      aliases: ["Risk Gatekeeper", "Patch Marshal", "Auth Sentinel"],
      motives: ["They raised a blocker and got overruled.", "They got blamed for a bug that was knowingly shipped.", "They watched a critical fix deprioritized for optics."],
      secrets: ["They kept a timeline of who approved risk acceptance.", "They have an unclosed incident draft.", "They know the exact minute the vuln became public."],
      clues: ["A P0 ticket marked 'won't fix'.", "A screenshot of failed auth logs.", "A postmortem template pre-filled before the incident."],
      drinks: ["Drink when someone says 'ship now patch later'.", "Drink when someone says 'it is not exploitable in practice'.", "Drink when someone says 'we never had this in staging'."]
    },
    ops: {
      aliases: ["Process Commander", "Runbook Whisperer", "Escalation Traffic Cop"],
      motives: ["They executed everything and received none of the credit.", "They were told to absorb a preventable fire drill.", "Their runbook was ignored during launch chaos."],
      secrets: ["They maintain a private timeline of every escalation.", "They know who ignored the final checklist.", "They have a voice note from the control room."],
      clues: ["A checklist with one unchecked box.", "A call log with repeated missed pings.", "A runbook page with emergency annotations."],
      drinks: ["Drink when someone says 'ops will handle it'.", "Drink when someone says 'not my lane'.", "Drink when someone says 'just one quick workaround'."]
    },
    business: {
      aliases: ["Slide Deck Surgeon", "Narrative Refiner", "Revenue Sleuth"],
      motives: ["They were told to present numbers they did not trust.", "They watched strategic decisions reverse overnight.", "They saw projections rewritten post-meeting."],
      secrets: ["They have the original board deck before edits.", "They know which assumptions were replaced last minute.", "They saved a redline version everyone forgot."],
      clues: ["A deck diff with hidden comments.", "A worksheet with conflicting assumptions.", "A note saying 'remove before sharing'."],
      drinks: ["Drink when someone says 'story over data'.", "Drink when someone says 'let us spin this'.", "Drink when someone says 'this is investor friendly'."]
    },
    founder: {
      aliases: ["Vision Broadcaster", "Deck Frontman", "Pitch Frequency"],
      motives: ["They backed the wrong person too publicly.", "They were promised strategic influence and shut out.", "They know where the original plan diverged."],
      secrets: ["They recorded one post-party conversation.", "They have a memo never sent to the board.", "They know who wanted a silent rewrite."],
      clues: ["A voice note with background music and panic.", "A draft memo with three redacted names.", "A playlist timestamped before the event shift."],
      drinks: ["Drink when someone says 'north star'.", "Drink when someone says 'we are still early'.", "Drink when someone says 'this is founder intuition'."]
    },
    growth: {
      aliases: ["Narrative Architect", "Acquisition Illusionist", "Funnel Cartographer"],
      motives: ["Their growth wins were used while their concerns were ignored.", "They were promised title/equity that never materialized.", "They got blamed for narrative decisions made elsewhere."],
      secrets: ["They know who wrote the final external script.", "They saved a draft that was never supposed to leak.", "They have timestamped edits that change motive."],
      clues: ["A campaign sheet with hidden audience filters.", "A message thread tagged 'do not forward'.", "A timeline doc with a missing 4-minute window."],
      drinks: ["Drink when someone says 'viral loop'.", "Drink when someone says 'organic'.", "Drink when someone says 'top of funnel solves all'."]
    },
    cos: {
      aliases: ["Calendar Enforcer", "Chief Orchestrator", "Decision Router"],
      motives: ["They carried decisions and got blamed for outcomes.", "They were asked to sanitize meeting notes.", "They know who knew what and when."],
      secrets: ["They keep private minutes of every conflict.", "They have an unshared action-item sheet.", "They know who skipped the critical call."],
      clues: ["A meeting note with contradictory action owners.", "A calendar invite edited three times.", "A notes app export titled 'actual truth'."],
      drinks: ["Drink when someone says 'circle back'.", "Drink when someone says 'parking lot this'.", "Drink when someone says 'let us move this thread'."]
    },
    tech: {
      aliases: ["Stack Whisperer", "Infra Tactician", "Release Cartographer"],
      motives: ["They warned about fragility before launch night.", "They were blamed for non-technical decisions.", "They shipped rescue fixes with no credit."],
      secrets: ["They have terminal logs from the critical hour.", "They know who approved the shadow deploy.", "They kept a hidden rollback plan."],
      clues: ["A log snippet with one impossible timestamp.", "A deploy message that was quickly deleted.", "A network graph screenshot from the outage window."],
      drinks: ["Drink when someone says 'backend issue' vaguely.", "Drink when someone says 'it worked on my machine'.", "Drink when someone says 'quick hotfix, no risk'."]
    },
    creative: {
      aliases: ["Sound Forensic", "Mood Curator", "Narrative DJ"],
      motives: ["Their work was reused without approval.", "They caught tonal mismatches and were ignored.", "They heard conversations nobody else did."],
      secrets: ["They have an audio clip with key voices.", "They know who changed tone minutes before launch.", "They saved a rough mix with hidden context."],
      clues: ["A waveform screenshot with a clipped segment.", "A playlist sequence that implies planning.", "A note about mic check at the wrong time."],
      drinks: ["Drink when someone says 'just play anything'.", "Drink when someone says 'vibe will cover it'.", "Drink when someone says 'audio is not important'."]
    },
    commercial: {
      aliases: ["Margin Navigator", "Category Closer", "Deal Thermostat"],
      motives: ["They structured a plan that was ignored for optics.", "They watched commitments get changed after handshakes.", "They were promised support but got last-minute pivots."],
      secrets: ["They saved the pre-pivot commercial sheet.", "They know who approved the steep discount.", "They have one vendor call recording."],
      clues: ["A margin sheet with two conflicting versions.", "A deal memo with crossed-out terms.", "A chat screenshot agreeing to numbers never shipped."],
      drinks: ["Drink when someone says 'small discount'.", "Drink when someone says 'margin later'.", "Drink when someone says 'this is strategic burn'."]
    },
    wildcard: {
      aliases: ["Neighbor Witness", "Out-of-Org Variable", "Silent Observer"],
      motives: ["They were present for conversations they were not meant to hear.", "They know one side of the story is staged.", "They saw a timing mismatch in real time."],
      secrets: ["They have a message screenshot from someone inside.", "They know why one person arrived unusually late.", "They noticed a missing clue before anyone else."],
      clues: ["A photo with one missing attendee.", "A timestamped text saying 'not now'.", "A parking note that breaks an alibi."],
      drinks: ["Drink when someone asks why you are here.", "Drink when someone says 'you are neutral'.", "Drink when someone says 'this is irrelevant'."]
    }
  };

  const SUPERPOWERS = [
    "Can turn chaos into a three-point action list in under 40 seconds.",
    "Asks one question that makes everyone reopen the deck.",
    "Finds the missing owner of any task without checking Slack.",
    "Can decode vague feedback into actual next steps instantly.",
    "Can summarize a 45-minute debate into one honest sentence.",
    "Reads meeting energy and predicts who will block the decision.",
    "Can rescue broken timelines by reordering dependencies on the fly.",
    "Can detect fake confidence in metrics before slide 3."
  ];

  const PARTY_TASKS = [
    "Get two guests from different circles to introduce themselves properly and report one surprising common point.",
    "Pitch a ridiculous startup idea in 20 seconds and get at least one vote of confidence.",
    "Collect one contradictory statement and present it to your team as evidence.",
    "Convince someone from the other floor to switch floors for one full track.",
    "Get one person to reveal a real career mistake disguised as a 'case study'.",
    "Submit one song request as a fake PRD with a success metric.",
    "Bring one new guest into your round and assign them a believable motive.",
    "Find one person who can be your alibi and one person who cannot."
  ];

  const EL = {
    screens: {
      landing: document.getElementById('screen-landing'),
      profile: document.getElementById('screen-profile'),
      game: document.getElementById('screen-game'),
      loading: document.getElementById('screen-loading'),
      character: document.getElementById('screen-character')
    },
    startBtn: document.getElementById('start-btn'),
    toGameBtn: document.getElementById('to-game-btn'),
    backToLandingBtn: document.getElementById('back-to-landing-btn'),
    profileError: document.getElementById('profile-error'),
    nameInput: document.getElementById('name-input'),
    vibeInput: document.getElementById('vibe-input'),
    adjectiveInput: document.getElementById('adjective-input'),
    loreInput: document.getElementById('lore-input'),
    gameStartBtn: document.getElementById('game-start-btn'),
    gameResetBtn: document.getElementById('game-reset-btn'),
    gameBackBtn: document.getElementById('game-back-btn'),
    mobileJumpBtn: document.getElementById('mobile-jump-btn'),
    gameStatus: document.getElementById('game-status'),
    hudAge: document.getElementById('hud-age'),
    hudDistance: document.getElementById('hud-distance'),
    hudStage: document.getElementById('hud-stage'),
    hudLives: document.getElementById('hud-lives'),
    loadingMsg: document.getElementById('loading-msg'),
    charAlias: document.getElementById('char-alias'),
    charName: document.getElementById('char-name'),
    charRole: document.getElementById('char-role'),
    charBio: document.getElementById('char-bio'),
    charMotive: document.getElementById('char-motive'),
    charSecret: document.getElementById('char-secret'),
    charClue: document.getElementById('char-clue'),
    charDrink: document.getElementById('char-drink'),
    charSuperpower: document.getElementById('char-superpower'),
    charTask: document.getElementById('char-task'),
    storySynopsis1: document.getElementById('story-synopsis-1'),
    storySynopsis2: document.getElementById('story-synopsis-2'),
    apiError: document.getElementById('api-error'),
    rsvpBtn: document.getElementById('rsvp-btn'),
    rsvpSubmitBtn: document.getElementById('rsvp-submit-btn'),
    rsvpStatus: document.getElementById('rsvp-status'),
    rsvpEta: document.getElementById('rsvp-eta'),
    rsvpNote: document.getElementById('rsvp-note'),
    regenBtn: document.getElementById('regen-btn'),
    replayBtn: document.getElementById('replay-btn')
  };

  const profile = {
    name: "",
    vibe: "",
    adjective: "",
    lore: ""
  };

  let lastCharacter = null;

  function showScreen(name) {
    Object.values(EL.screens).forEach((s) => s.classList.remove('active'));
    EL.screens[name].classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function setError(el, message) {
    el.textContent = message || '';
    el.style.display = message ? 'block' : 'none';
  }

  function setOk(el, message) {
    el.textContent = message || '';
    el.style.display = message ? 'block' : 'none';
  }

  function readProfile() {
    profile.name = EL.nameInput.value.trim();
    profile.vibe = EL.vibeInput.value;
    profile.adjective = EL.adjectiveInput.value.trim();
    profile.lore = EL.loreInput.value.trim();
  }

  function validateProfile() {
    if (!profile.name || profile.name.length < 2) return 'Enter first name as on Aadhaar so we can map your assigned role.';
    return '';
  }

  EL.startBtn.addEventListener('click', () => showScreen('profile'));
  EL.backToLandingBtn.addEventListener('click', () => showScreen('landing'));

  EL.toGameBtn.addEventListener('click', () => {
    readProfile();
    const err = validateProfile();
    setError(EL.profileError, err);
    if (err) return;
    showScreen('game');
  });

  // -------------------------
  // Age Runner mini game
  // -------------------------
  const canvas = document.getElementById('runner-canvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width;
  const H = canvas.height;
  const GROUND = 186;
  const IS_MOBILE = window.matchMedia('(max-width: 760px)').matches || ('ontouchstart' in window);
  const GAME_TUNING = IS_MOBILE
    ? { totalDistance: 9800, minSpeed: 132, maxSpeed: 172, startLives: 6, threatGap: 2.9, boostGap: 4.9 }
    : { totalDistance: 10800, minSpeed: 150, maxSpeed: 190, startLives: 5, threatGap: 2.3, boostGap: 5.8 };

  const STAGES = [
    { age: 0, label: 'Nursery', accent: '#f3b27a' },
    { age: 4, label: 'School', accent: '#7fc6ea' },
    { age: 10, label: 'Boards', accent: '#a88ce0' },
    { age: 16, label: 'Coaching', accent: '#e19568' },
    { age: 19, label: 'College', accent: '#79d2a5' },
    { age: 22, label: 'Placements', accent: '#8fd0df' },
    { age: 25, label: 'Corporate', accent: '#e0b670' },
    { age: 27, label: 'Birthday Eve', accent: '#ffd46a' }
  ];

  const STAGE_THREATS = {
    'Nursery': [
      { label: 'Playground Bully', tag: 'BULLY', color: '#9f5f6d', w: 50, h: 34, kind: 'bully' },
      { label: 'Strict Teacher', tag: 'TEACH', color: '#7a668f', w: 52, h: 36, kind: 'teacher' }
    ],
    'School': [
      { label: 'Homework Monster', tag: 'HW', color: '#6b5d95', w: 62, h: 30, kind: 'paper' },
      { label: 'Class Teacher', tag: 'RULES', color: '#8b607c', w: 52, h: 36, kind: 'teacher' },
      { label: 'Unit Test', tag: 'TEST', color: '#7b677f', w: 56, h: 30, kind: 'exam' }
    ],
    'Boards': [
      { label: 'Board Exam Trap', tag: 'XII', color: '#8c5d6d', w: 64, h: 32, kind: 'exam' },
      { label: 'Syllabus Pile', tag: 'PDF', color: '#6f5f95', w: 56, h: 30, kind: 'books' },
      { label: 'Panic Alarm', tag: 'PANIC', color: '#856248', w: 48, h: 34, kind: 'alarm' }
    ],
    'Coaching': [
      { label: 'Coaching Sir', tag: 'SIR', color: '#9d6545', w: 52, h: 36, kind: 'coach' },
      { label: 'Rank Race', tag: 'RANK', color: '#8f586f', w: 60, h: 30, kind: 'hurdle' },
      { label: 'Mock Test Loop', tag: 'MOCK', color: '#73668c', w: 58, h: 30, kind: 'exam' }
    ],
    'College': [
      { label: '8AM Attendance', tag: '8AM', color: '#5f768f', w: 58, h: 30, kind: 'alarm' },
      { label: 'Proxy Failed', tag: 'PROXY', color: '#7c5f8b', w: 54, h: 30, kind: 'idcard' },
      { label: 'Project Vampire', tag: 'TEAM', color: '#6a6a93', w: 58, h: 34, kind: 'bully' }
    ],
    'Placements': [
      { label: 'Case Interview', tag: 'CASE', color: '#6d747f', w: 58, h: 34, kind: 'coach' },
      { label: 'Resume Roast', tag: 'CV', color: '#5b7d79', w: 56, h: 30, kind: 'paper' },
      { label: 'Offer Waitlist', tag: 'HR', color: '#716789', w: 52, h: 34, kind: 'hourglass' }
    ],
    'Corporate': [
      { label: 'Deadline Dragon', tag: 'DL', color: '#6d6c7d', w: 64, h: 32, kind: 'snake' },
      { label: 'Rent Spike', tag: 'RENT', color: '#8a6c54', w: 56, h: 30, kind: 'bill' },
      { label: 'Scope Creep', tag: 'SCOPE', color: '#815f72', w: 60, h: 32, kind: 'snake' },
      { label: 'Weekend Deploy', tag: 'DEPLOY', color: '#6a7a5a', w: 56, h: 32, kind: 'laptop' }
    ],
    'Birthday Eve': [
      { label: 'Shaadi Question', tag: 'AUNTY', color: '#8a5c67', w: 60, h: 32, kind: 'speech' },
      { label: 'Photo Delay', tag: 'POSE', color: '#6a6f87', w: 56, h: 31, kind: 'camera' },
      { label: 'Cake Crisis', tag: 'CAKE', color: '#8c7453', w: 54, h: 29, kind: 'cake' }
    ]
  };

  const STAGE_BOOSTS = {
    'Nursery': [
      { label: 'Gold Star Sticker', tag: 'STAR', kind: 'star', color: '#ffd977', effect: 'life' },
      { label: 'Drawing Prize', tag: 'ART', kind: 'trophy', color: '#ffb77a', effect: 'life' }
    ],
    'School': [
      { label: 'Sports Day Medal', tag: 'SPORT', kind: 'medal', color: '#79d2a5', effect: 'life' },
      { label: 'Debate Win', tag: 'DEBATE', kind: 'badge', color: '#8fd0df', effect: 'shield' }
    ],
    'Boards': [
      { label: 'Study Group Buff', tag: 'GROUP', kind: 'shield', color: '#a88ce0', effect: 'shield' },
      { label: 'Teacher Appreciation', tag: 'GRACE', kind: 'heart', color: '#e7b16a', effect: 'life' }
    ],
    'Coaching': [
      { label: 'Mock Test Topper', tag: 'TOP', kind: 'trophy', color: '#e7ba70', effect: 'life' },
      { label: 'Doubt Session Clarity', tag: 'CLEAR', kind: 'shield', color: '#7fc6ea', effect: 'shield' }
    ],
    'College': [
      { label: 'Fest Pass', tag: 'FEST', kind: 'ticket', color: '#f0ba77', effect: 'life' },
      { label: 'Hackathon Boost', tag: 'HACK', kind: 'bolt', color: '#78d6ad', effect: 'shield' }
    ],
    'Placements': [
      { label: 'Referral Magic', tag: 'REF', kind: 'star', color: '#ffd977', effect: 'life' },
      { label: 'Mock Interview Buff', tag: 'MOCK+', kind: 'shield', color: '#8fd0df', effect: 'shield' }
    ],
    'Corporate': [
      { label: 'Weekend Recovery', tag: 'REST', kind: 'heart', color: '#f5a0a0', effect: 'life' },
      { label: 'Team Backup', tag: 'ALLY', kind: 'shield', color: '#78c7ff', effect: 'shield' }
    ],
    'Birthday Eve': [
      { label: 'Birthday Hype', tag: 'HYPE', kind: 'trophy', color: '#ffd977', effect: 'life' },
      { label: 'Friend Rescue', tag: 'BRO', kind: 'shield', color: '#9adcae', effect: 'shield' }
    ]
  };

  const STAR_FIELD = Array.from({ length: 30 }, () => ({
    x: Math.random() * W,
    y: Math.random() * (GROUND - 110),
    r: 1 + Math.random() * 1.4
  }));

  const CLOUDS = Array.from({ length: 6 }, (_, i) => ({
    x: i * 170 + Math.random() * 40,
    y: 16 + Math.random() * 52,
    w: 80 + Math.random() * 55,
    h: 16 + Math.random() * 10,
    speed: 8 + Math.random() * 10
  }));

  const HILLS = Array.from({ length: 12 }, (_, i) => ({
    x: i * 90,
    w: 130 + Math.random() * 60,
    h: 36 + Math.random() * 30
  }));

  const LIGHT_BLOBS = Array.from({ length: 9 }, () => ({
    x: Math.random() * W,
    y: 30 + Math.random() * 80,
    r: 22 + Math.random() * 20,
    hue: 35 + Math.random() * 35
  }));

  const game = {
    running: false,
    won: false,
    age: 0,
    progress: 0,
    distance: 0,
    totalDistance: GAME_TUNING.totalDistance,
    speed: GAME_TUNING.minSpeed,
    minSpeed: GAME_TUNING.minSpeed,
    maxSpeed: GAME_TUNING.maxSpeed,
    gravity: 1550,
    jumpVelocity: -590,
    threatTimer: 0,
    nextThreatIn: GAME_TUNING.threatGap,
    boostTimer: 0,
    nextBoostIn: GAME_TUNING.boostGap,
    hitCooldown: 0,
    shieldTime: 0,
    lastTs: 0,
    lives: GAME_TUNING.startLives,
    lastStage: 'Nursery',
    stageFlashTimer: 0,
    player: {
      x: 92,
      y: GROUND,
      vy: 0,
      onGround: true,
      coyote: 0,
      airJumps: 1
    },
    threats: [],
    boosts: []
  };

  function stageForAge(age) {
    let stage = STAGES[0];
    for (let i = 0; i < STAGES.length; i += 1) {
      if (age >= STAGES[i].age) stage = STAGES[i];
    }
    return stage;
  }

  function currentStage(age) {
    return stageForAge(age).label;
  }

  function playerLook(age) {
    if (age < 4) return { bodyH: 24, bodyW: 18, suit: '#ffd39f', prop: 'rattle' };
    if (age < 10) return { bodyH: 27, bodyW: 20, suit: '#84c1ff', prop: 'bag' };
    if (age < 16) return { bodyH: 30, bodyW: 22, suit: '#a88ce0', prop: 'books' };
    if (age < 22) return { bodyH: 33, bodyW: 22, suit: '#78d6ad', prop: 'cap' };
    if (age < 27) return { bodyH: 35, bodyW: 23, suit: '#efba72', prop: 'laptop' };
    return { bodyH: 36, bodyW: 24, suit: '#f0d37a', prop: 'party' };
  }

  function playerBounds() {
    const look = playerLook(game.age);
    return { x: game.player.x, y: game.player.y - look.bodyH, width: look.bodyW, height: look.bodyH, look };
  }

  function roundedRect(x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r);
    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath();
  }

  function resetGame() {
    game.running = false;
    game.won = false;
    game.age = 0;
    game.progress = 0;
    game.distance = 0;
    game.speed = game.minSpeed;
    game.threatTimer = 0;
    game.nextThreatIn = GAME_TUNING.threatGap;
    game.boostTimer = 0;
    game.nextBoostIn = GAME_TUNING.boostGap;
    game.hitCooldown = 0;
    game.shieldTime = 0;
    game.lastTs = 0;
    game.lives = GAME_TUNING.startLives;
    game.lastStage = 'Nursery';
    game.stageFlashTimer = 0;
    game.player.y = GROUND;
    game.player.vy = 0;
    game.player.onGround = true;
    game.player.coyote = 0;
    game.player.airJumps = 1;
    game.threats = [];
    game.boosts = [];
    updateHUD();
    drawFrame();
    EL.gameStatus.textContent = `Press start. You have ${GAME_TUNING.startLives} lives. Collect extracurricular boosts.`;
  }

  function jump() {
    if (!game.running) return;
    if (game.player.onGround || game.player.coyote > 0) {
      game.player.vy = game.jumpVelocity;
      game.player.onGround = false;
      game.player.coyote = 0;
      return;
    }
    if (game.player.airJumps > 0) {
      game.player.vy = game.jumpVelocity * 0.9;
      game.player.airJumps -= 1;
    }
  }

  function spawnThreat() {
    const stage = stageForAge(game.age).label;
    const catalog = STAGE_THREATS[stage] || STAGE_THREATS.Corporate;
    const t = catalog[Math.floor(Math.random() * catalog.length)];
    game.threats.push({
      x: W + 14,
      y: GROUND - t.h,
      width: t.w,
      height: t.h,
      label: t.label,
      tag: t.tag,
      kind: t.kind,
      color: t.color
    });
    game.threatTimer = 0;
    const gapBase = GAME_TUNING.threatGap - Math.min(0.5, game.progress * 0.5);
    game.nextThreatIn = gapBase + Math.random() * 1.05;
  }

  function spawnBoost() {
    const stage = stageForAge(game.age).label;
    const catalog = STAGE_BOOSTS[stage] || STAGE_BOOSTS.Corporate;
    const b = catalog[Math.floor(Math.random() * catalog.length)];
    const size = 28;
    game.boosts.push({
      x: W + 14,
      y: GROUND - 90 - Math.random() * 55,
      width: size,
      height: size,
      label: b.label,
      tag: b.tag,
      kind: b.kind,
      color: b.color,
      effect: b.effect
    });
    game.boostTimer = 0;
    game.nextBoostIn = (GAME_TUNING.boostGap - 1.1) + Math.random() * 3.2;
  }

  function collides(a, b) {
    return a.x < b.x + b.width && a.x + a.width > b.x && a.y < b.y + b.height && a.y + a.height > b.y;
  }

  function updateHUD() {
    EL.hudAge.textContent = `Age: ${game.age}`;
    EL.hudDistance.textContent = `Progress: ${Math.min(100, Math.floor(game.progress * 100))}%`;
    EL.hudStage.textContent = `Stage: ${currentStage(game.age)}${game.shieldTime > 0 ? ' | Shield' : ''}`;
    EL.hudLives.textContent = `Lives: ${game.lives}`;
  }

  function drawPlayer() {
    const p = playerBounds();
    const look = p.look;

    if (game.hitCooldown > 0 && Math.floor(game.hitCooldown * 16) % 2 === 0) return;

    if (game.shieldTime > 0) {
      ctx.beginPath();
      ctx.arc(p.x + p.width / 2, p.y + p.height / 2, Math.max(p.width, p.height) * 0.85, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(132, 198, 255, 0.24)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(132, 198, 255, 0.7)';
      ctx.stroke();
    }

    ctx.fillStyle = look.suit;
    ctx.fillRect(p.x, p.y, p.width, p.height);

    ctx.fillStyle = '#e8d5b3';
    const headR = 6 + Math.min(4, game.age / 9);
    ctx.beginPath();
    ctx.arc(p.x + p.width / 2, p.y - headR + 2, headR, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = '#2a1d0d';
    ctx.fillRect(p.x + Math.floor(p.width * 0.25), p.y + 8, 3, 3);

    if (look.prop === 'rattle') {
      ctx.fillStyle = '#f9c96f';
      ctx.fillRect(p.x + p.width + 3, p.y + 10, 6, 6);
    }
    if (look.prop === 'bag') {
      ctx.fillStyle = '#4c5b7a';
      ctx.fillRect(p.x - 7, p.y + 8, 6, 12);
    }
    if (look.prop === 'books') {
      ctx.fillStyle = '#7a4c93';
      ctx.fillRect(p.x + p.width, p.y + 11, 7, 10);
    }
    if (look.prop === 'cap') {
      ctx.fillStyle = '#26313f';
      ctx.fillRect(p.x + 3, p.y - headR - 5, p.width - 6, 3);
    }
    if (look.prop === 'laptop') {
      ctx.fillStyle = '#576372';
      ctx.fillRect(p.x + p.width + 2, p.y + 13, 9, 7);
    }
    if (look.prop === 'party') {
      ctx.fillStyle = '#ff9a6c';
      ctx.beginPath();
      ctx.moveTo(p.x + p.width / 2, p.y - headR - 11);
      ctx.lineTo(p.x + p.width / 2 - 6, p.y - headR + 1);
      ctx.lineTo(p.x + p.width / 2 + 6, p.y - headR + 1);
      ctx.closePath();
      ctx.fill();
    }
  }

  function drawThreat(threat) {
    const { x, y, width: w, height: h, color, kind } = threat;
    ctx.save();
    ctx.translate(x, y);
    roundedRect(0, 0, w, h, 8);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = '#1d1511';
    ctx.stroke();

    if (kind === 'bully' || kind === 'teacher' || kind === 'coach') {
      ctx.fillStyle = '#f2dcc0';
      ctx.beginPath();
      ctx.arc(w / 2, 11, 7, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#332018';
      ctx.fillRect(w / 2 - 8, 21, 16, h - 25);
      if (kind !== 'bully') {
        ctx.fillStyle = '#d7e5ff';
        ctx.fillRect(w / 2 + 8, 16, 2, h - 16);
      }
    } else if (kind === 'exam' || kind === 'paper') {
      ctx.fillStyle = '#f4e9d2';
      ctx.fillRect(6, 5, w - 12, h - 10);
      ctx.fillStyle = '#8a6c54';
      for (let i = 0; i < 3; i += 1) ctx.fillRect(10, 10 + i * 6, w - 20, 2);
    } else if (kind === 'snake') {
      ctx.strokeStyle = '#2b141f';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(8, h - 8);
      ctx.bezierCurveTo(w * 0.3, h - 25, w * 0.6, h + 3, w - 8, h - 18);
      ctx.stroke();
    } else if (kind === 'camera') {
      ctx.fillStyle = '#d8e0ef';
      ctx.fillRect(8, 9, w - 16, h - 18);
      ctx.fillStyle = '#68758b';
      ctx.beginPath();
      ctx.arc(w / 2, h / 2, 6, 0, Math.PI * 2);
      ctx.fill();
    } else if (kind === 'cake') {
      ctx.fillStyle = '#f2d7b0';
      ctx.fillRect(8, h - 15, w - 16, 11);
      ctx.fillStyle = '#eab0b0';
      ctx.fillRect(8, h - 22, w - 16, 7);
    } else if (kind === 'hourglass') {
      ctx.strokeStyle = '#f0d6b4';
      ctx.strokeRect(12, 6, w - 24, h - 12);
      ctx.beginPath();
      ctx.moveTo(14, 8);
      ctx.lineTo(w - 14, h - 8);
      ctx.moveTo(w - 14, 8);
      ctx.lineTo(14, h - 8);
      ctx.stroke();
    } else if (kind === 'alarm') {
      ctx.beginPath();
      ctx.arc(w / 2, h / 2, 10, 0, Math.PI * 2);
      ctx.fillStyle = '#ece2cb';
      ctx.fill();
      ctx.fillStyle = '#7c5f8b';
      ctx.fillRect(w / 2 - 1, h / 2 - 8, 2, 8);
    } else if (kind === 'bill') {
      ctx.fillStyle = '#f4e5c6';
      ctx.fillRect(8, 7, w - 16, h - 14);
      ctx.fillStyle = '#8c5b5b';
      ctx.fillRect(12, h - 15, 10, 2);
      ctx.fillRect(12, h - 11, 7, 2);
    } else if (kind === 'laptop') {
      ctx.fillStyle = '#ced9e8';
      ctx.fillRect(8, 8, w - 16, h - 18);
      ctx.fillStyle = '#4f5f76';
      ctx.fillRect(6, h - 10, w - 12, 6);
    } else if (kind === 'speech') {
      roundedRect(8, 8, w - 16, h - 16, 8);
      ctx.fillStyle = '#f0d7b0';
      ctx.fill();
      ctx.fillStyle = '#825d7c';
      ctx.fillRect(12, 14, w - 24, 3);
    } else if (kind === 'idcard') {
      roundedRect(8, 7, w - 16, h - 14, 4);
      ctx.fillStyle = '#d7e4ff';
      ctx.fill();
      ctx.fillStyle = '#60708a';
      ctx.fillRect(12, 13, w - 24, 4);
    } else if (kind === 'hurdle') {
      ctx.fillStyle = '#a26d6d';
      ctx.fillRect(8, h - 12, w - 16, 8);
      ctx.fillRect(12, h - 22, 4, 10);
      ctx.fillRect(w - 16, h - 22, 4, 10);
    }

    ctx.restore();
  }

  function drawBoost(boost) {
    const { x, y, width: w, height: h, kind, color } = boost;
    ctx.save();
    ctx.translate(x, y);
    ctx.beginPath();
    ctx.arc(w / 2, h / 2, w / 2, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(10, 12, 15, 0.45)';
    ctx.fill();

    ctx.beginPath();
    ctx.arc(w / 2, h / 2, w / 2 - 2, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = '#f7e8bf';
    ctx.stroke();

    ctx.fillStyle = '#2b1d0e';
    if (kind === 'medal' || kind === 'trophy') {
      ctx.fillRect(w / 2 - 3, 9, 6, 9);
      ctx.fillRect(w / 2 - 7, 18, 14, 3);
    } else if (kind === 'shield') {
      ctx.beginPath();
      ctx.moveTo(w / 2, 7);
      ctx.lineTo(w - 8, 11);
      ctx.lineTo(w - 10, 19);
      ctx.lineTo(w / 2, h - 8);
      ctx.lineTo(10, 19);
      ctx.lineTo(8, 11);
      ctx.closePath();
      ctx.fill();
    } else if (kind === 'bolt') {
      ctx.beginPath();
      ctx.moveTo(w / 2 + 1, 7);
      ctx.lineTo(w / 2 - 5, 15);
      ctx.lineTo(w / 2, 15);
      ctx.lineTo(w / 2 - 2, 23);
      ctx.lineTo(w / 2 + 6, 13);
      ctx.lineTo(w / 2 + 1, 13);
      ctx.closePath();
      ctx.fill();
    } else if (kind === 'ticket') {
      roundedRect(7, 9, w - 14, h - 18, 3);
      ctx.fill();
    } else if (kind === 'heart') {
      ctx.beginPath();
      ctx.arc(w / 2 - 4, 12, 4, 0, Math.PI * 2);
      ctx.arc(w / 2 + 4, 12, 4, 0, Math.PI * 2);
      ctx.lineTo(w / 2, 22);
      ctx.closePath();
      ctx.fill();
    } else {
      ctx.fillRect(w / 2 - 2, 8, 4, 12);
      ctx.fillRect(w / 2 - 8, 12, 16, 4);
    }

    ctx.restore();
  }

  function drawTimeline() {
    const tx = 24;
    const ty = 18;
    const tw = W - 48;
    const th = 5;
    ctx.fillStyle = 'rgba(255,255,255,0.16)';
    ctx.fillRect(tx, ty, tw, th);
    ctx.fillStyle = '#f2c76b';
    ctx.fillRect(tx, ty, tw * game.progress, th);
    STAGES.forEach((s) => {
      const mx = tx + (s.age / 27) * tw;
      ctx.beginPath();
      ctx.arc(mx, ty + th / 2, 3, 0, Math.PI * 2);
      ctx.fillStyle = s.accent;
      ctx.fill();
    });
  }

  function drawBackground() {
    const sky = ctx.createLinearGradient(0, 0, 0, GROUND + 12);
    sky.addColorStop(0, '#1b2433');
    sky.addColorStop(0.55, '#161d27');
    sky.addColorStop(1, '#22180f');
    ctx.fillStyle = sky;
    ctx.fillRect(0, 0, W, H);

    LIGHT_BLOBS.forEach((b, i) => {
      const swing = Math.sin((game.distance * 0.0015) + i) * 16;
      const gx = b.x + swing;
      const grad = ctx.createRadialGradient(gx, b.y, 1, gx, b.y, b.r);
      grad.addColorStop(0, `hsla(${b.hue}, 90%, 72%, 0.16)`);
      grad.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(gx, b.y, b.r, 0, Math.PI * 2);
      ctx.fill();
    });

    STAR_FIELD.forEach((s) => {
      ctx.fillStyle = 'rgba(255, 245, 210, 0.45)';
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
      ctx.fill();
    });

    CLOUDS.forEach((c) => {
      const x = (c.x - (game.distance * c.speed) / 130) % (W + 140);
      const px = x < -140 ? x + W + 140 : x;
      ctx.fillStyle = 'rgba(216, 228, 244, 0.2)';
      roundedRect(px, c.y, c.w, c.h, 9);
      ctx.fill();
    });

    HILLS.forEach((h, idx) => {
      const px = (h.x - game.distance * (0.14 + idx * 0.003)) % (W + 180);
      const x = px < -180 ? px + W + 180 : px;
      ctx.fillStyle = idx % 2 ? 'rgba(43, 53, 69, 0.42)' : 'rgba(58, 69, 86, 0.35)';
      ctx.beginPath();
      ctx.ellipse(x + h.w * 0.5, GROUND + 4, h.w * 0.55, h.h, 0, Math.PI, 0, true);
      ctx.fill();
    });

    ctx.fillStyle = '#b09263';
    ctx.fillRect(0, GROUND + 2, W, 2);
    ctx.fillStyle = 'rgba(255,255,255,0.09)';
    const dashOffset = (game.distance * 0.62) % 44;
    for (let i = -1; i < W / 44 + 2; i += 1) {
      ctx.fillRect(i * 44 - dashOffset, GROUND + 9, 20, 2);
    }
    drawTimeline();
  }

  function drawStageFlash() {
    if (game.stageFlashTimer <= 0) return;
    const alpha = Math.min(0.34, game.stageFlashTimer * 0.42);
    ctx.fillStyle = `rgba(242, 199, 107, ${alpha})`;
    ctx.fillRect(0, 0, W, 34);
  }

  function drawFrame() {
    drawBackground();
    game.boosts.forEach(drawBoost);
    game.threats.forEach(drawThreat);
    drawPlayer();
    drawStageFlash();
  }

  function failRun(hit) {
    game.running = false;
    EL.gameStatus.textContent = `Knocked out by "${hit.label}". Reset and try again.`;
  }

  function registerHit(hit) {
    if (game.shieldTime > 0) {
      game.threats = game.threats.filter((t) => t !== hit);
      EL.gameStatus.textContent = `Shield blocked ${hit.label}.`;
      return;
    }
    game.lives -= 1;
    game.hitCooldown = 1.0;
    game.threats = game.threats.filter((t) => t !== hit);
    if (game.lives <= 0) {
      failRun(hit);
      return;
    }
    EL.gameStatus.textContent = `Hit by ${hit.label}. Lives left: ${game.lives}.`;
  }

  function collectBoost(boost) {
    game.boosts = game.boosts.filter((b) => b !== boost);
    if (boost.effect === 'life') {
      game.lives = Math.min(9, game.lives + 1);
      EL.gameStatus.textContent = `Collected ${boost.label}. +1 life!`;
    } else {
      game.shieldTime = 4.5;
      EL.gameStatus.textContent = `${boost.label} active. Shield for a few seconds.`;
    }
  }

  async function winRun() {
    game.running = false;
    game.won = true;
    EL.gameStatus.textContent = 'Reached 27. Unlocking your dossier...';
    showScreen('loading');
    await loadCharacter();
  }

  function tick(ts) {
    if (!game.running) return;
    if (!game.lastTs) game.lastTs = ts;
    const dt = Math.min(0.033, (ts - game.lastTs) / 1000);
    game.lastTs = ts;

    game.distance += game.speed * dt;
    game.progress = Math.min(1, game.distance / game.totalDistance);
    game.age = Math.min(27, Math.floor(game.progress * 27));
    game.speed = Math.min(game.maxSpeed, game.minSpeed + game.progress * 40);

    const stage = stageForAge(game.age);
    if (stage.label !== game.lastStage) {
      game.lastStage = stage.label;
      game.stageFlashTimer = 0.9;
      EL.gameStatus.textContent = `Checkpoint reached: ${stage.label}`;
    }

    if (game.stageFlashTimer > 0) game.stageFlashTimer = Math.max(0, game.stageFlashTimer - dt);
    if (game.hitCooldown > 0) game.hitCooldown = Math.max(0, game.hitCooldown - dt);
    if (game.shieldTime > 0) game.shieldTime = Math.max(0, game.shieldTime - dt);

    game.player.vy += game.gravity * dt;
    game.player.y += game.player.vy * dt;
    game.player.coyote = Math.max(0, game.player.coyote - dt);

    if (game.player.y >= GROUND) {
      game.player.y = GROUND;
      game.player.vy = 0;
      game.player.onGround = true;
      game.player.coyote = 0.14;
      game.player.airJumps = 1;
    } else {
      game.player.onGround = false;
    }

    game.threatTimer += dt;
    if (game.threatTimer >= game.nextThreatIn) spawnThreat();
    game.boostTimer += dt;
    if (game.boostTimer >= game.nextBoostIn) spawnBoost();

    const p = playerBounds();
    for (let i = game.threats.length - 1; i >= 0; i -= 1) {
      const t = game.threats[i];
      t.x -= game.speed * dt;
      if (t.x + t.width < -10) {
        game.threats.splice(i, 1);
        continue;
      }
      if (game.hitCooldown <= 0 && collides(p, t)) registerHit(t);
    }

    for (let i = game.boosts.length - 1; i >= 0; i -= 1) {
      const b = game.boosts[i];
      b.x -= game.speed * dt * 0.88;
      if (b.x + b.width < -10) {
        game.boosts.splice(i, 1);
        continue;
      }
      if (collides(p, b)) collectBoost(b);
    }

    updateHUD();
    drawFrame();

    if (game.running && game.progress >= 1) {
      winRun();
      return;
    }
    requestAnimationFrame(tick);
  }

  EL.gameStartBtn.addEventListener('click', () => {
    if (game.running) return;
    if (game.won || game.distance > 0 || game.lives <= 0) resetGame();
    readProfile();
    const err = validateProfile();
    if (err) {
      setError(EL.profileError, err);
      showScreen('profile');
      return;
    }
    game.running = true;
    game.lastTs = 0;
    EL.gameStatus.textContent = 'Run started. Beat enemies, avoid traps, collect boosts.';
    requestAnimationFrame(tick);
  });

  EL.gameResetBtn.addEventListener('click', resetGame);
  EL.gameBackBtn.addEventListener('click', () => showScreen('profile'));

  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
      e.preventDefault();
      jump();
    }
  });

  canvas.addEventListener('pointerdown', jump);
  if (EL.mobileJumpBtn) EL.mobileJumpBtn.addEventListener('pointerdown', jump);

  // -------------------------
  // Character generation
  // -------------------------
  let shuffleOffset = 0;

  function normalizeText(v) {
    return String(v || '').toLowerCase().replace(/[^a-z0-9 ]+/g, ' ').replace(/\s+/g, ' ').trim();
  }

  function hashString(input) {
    let h = 2166136261;
    for (let i = 0; i < input.length; i += 1) {
      h ^= input.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return Math.abs(h >>> 0);
  }

  function pickBySeed(list, seed, offset = 0) {
    if (!list || !list.length) return '';
    return list[(seed + offset) % list.length];
  }

  function toTitleCase(input) {
    return String(input || '')
      .trim()
      .toLowerCase()
      .replace(/\b\w/g, (m) => m.toUpperCase());
  }

  function canonicalFirstName(input) {
    const raw = normalizeText(input).split(' ')[0] || '';
    if (!raw) return '';
    if (raw.startsWith('aishw') || raw.startsWith('aisw')) return 'aishwarya';
    const aliasMap = {
      deva: 'devashish',
      devas: 'devashish',
      dev: 'devashish',
      narenn: 'naren',
      shren: 'shrenik',
      kov: 'kovid',
      siddy: 'siddak',
      sid: 'siddak',
      ritik: 'ritvik',
      gunj: 'gunjan',
      bhar: 'bharat'
    };
    return aliasMap[raw] || raw;
  }

  function prettyFirstName(input) {
    const c = canonicalFirstName(input);
    if (!c) return '';
    return c.charAt(0).toUpperCase() + c.slice(1);
  }

  function findRosterMatch(nameInput) {
    const first = canonicalFirstName(nameInput);
    if (!first) return null;

    function editDistance(a, b) {
      const dp = Array.from({ length: a.length + 1 }, () => Array(b.length + 1).fill(0));
      for (let i = 0; i <= a.length; i += 1) dp[i][0] = i;
      for (let j = 0; j <= b.length; j += 1) dp[0][j] = j;
      for (let i = 1; i <= a.length; i += 1) {
        for (let j = 1; j <= b.length; j += 1) {
          const cost = a[i - 1] === b[j - 1] ? 0 : 1;
          dp[i][j] = Math.min(dp[i - 1][j] + 1, dp[i][j - 1] + 1, dp[i - 1][j - 1] + cost);
        }
      }
      return dp[a.length][b.length];
    }

    function score(input, candidate) {
      if (input === candidate) return 100;
      if (candidate.startsWith(input)) return 82 + Math.min(12, input.length);
      if (input.startsWith(candidate)) return 72;
      if (candidate.includes(input) || input.includes(candidate)) return 66;
      if (input.length >= 4) {
        const d = editDistance(input, candidate);
        if (d <= 2) return 58 - d * 9;
      }
      return 0;
    }

    const ranked = GUEST_ROSTER.map((guest) => {
      const guestFirst = canonicalFirstName(guest.name);
      return { guest, s: score(first, guestFirst) };
    }).filter((x) => x.s > 0);

    if (!ranked.length) return null;
    ranked.sort((a, b) => b.s - a.s);
    const topScore = ranked[0].s;
    const finalists = ranked.filter((x) => x.s === topScore).map((x) => x.guest);

    if (first === 'aishwarya') {
      const aiFinalists = finalists.filter((g) => canonicalFirstName(g.name) === 'aishwarya');
      if (aiFinalists.length > 1) {
        return aiFinalists[Math.floor(Math.random() * aiFinalists.length)];
      }
    }

    if (finalists.length > 1) {
      return finalists[Math.floor(Math.random() * finalists.length)];
    }
    return finalists[0];
  }

  function buildMappedCharacter(seedOffset = 0) {
    const guest = findRosterMatch(profile.name);
    const archetype = guest ? guest.archetype : 'wildcard';
    const style = ARCHETYPE_STYLE[archetype] || ARCHETYPE_STYLE.wildcard;

    const firstName = guest ? prettyFirstName(guest.name) : prettyFirstName(profile.name);
    const adjective = toTitleCase(profile.adjective);
    const displayName = adjective ? `${adjective} ${firstName}` : firstName;
    const roleTitle = guest ? guest.title : 'Late Night Guest';
    const trait = guest ? guest.trait : 'suspiciously composed';

    const seed = hashString(`${displayName}|${roleTitle}|${profile.vibe}|${trait}|${profile.lore}|${seedOffset}`);
    const aliasCore = pickBySeed(style.aliases, seed);
    const motiveCore = pickBySeed(style.motives, seed, 1);
    const secretCore = pickBySeed(style.secrets, seed, 2);
    const clueCore = pickBySeed(style.clues, seed, 3);
    const drinkCore = pickBySeed(style.drinks, seed, 4);
    const superpower = pickBySeed(SUPERPOWERS, seed, 5);
    const missionTask = pickBySeed(PARTY_TASKS, seed, 7);

    const role = `${roleTitle} - ${aliasCore}`;
    const bio = `${displayName} is known for being ${trait}. In tonight's case file, they sit right in the ${archetype} fault-line where facts and narratives keep colliding.`;
    const motive = `${motiveCore} They intend to leave with leverage before midnight.`;
    const secret = `${secretCore} They will not reveal it unless cornered in Round 2.`;
    const clue = `${clueCore} This artifact can challenge at least one alibi.`;
    const alias = `The ${aliasCore}`;

    return { alias, role, bio, motive, secret, clue, drinkingCue: drinkCore, superpower, missionTask, displayName, archetype, roleTitle };
  }

  function buildInviteSynopsis(character) {
    const relationMap = {
      product: 'the product war-room',
      data: 'the analytics bunker',
      finance: 'the treasury desk',
      crypto: 'the treasury wallet trail',
      ai: 'the prompt and model pipeline',
      design: 'the design review lane',
      security: 'the incident channel',
      ops: 'the launch operations desk',
      business: 'the board-deck tunnel',
      founder: 'the founder inner-circle',
      growth: 'the narrative control room',
      cos: 'the decision corridor',
      tech: 'the deployment bridge',
      creative: 'the sound booth and side conversations',
      commercial: 'the deal table',
      wildcard: 'the hallway where nobody thought you were listening'
    };
    const relation = relationMap[character.archetype] || 'the launch floor';
    const p1 = `One year ago, Vikram \"V\" Vora was murdered during the Grove Labs launch night. You were not a random guest. As ${character.roleTitle}, ${character.displayName} stood inside ${relation} and saw the night split into truth, panic, and silence.`;
    const p2 = `Tonight everyone returns to The Grove A7. Not to remember him, but to reopen what was buried. This was not a one-person crime; it was a chain of intent, omission, and cover-up. At 8 PM the story starts, and every alibi gets tested.`;
    return { p1, p2 };
  }

  function renderCharacter(character) {
    EL.charAlias.textContent = character.alias;
    EL.charName.textContent = character.displayName || profile.name;
    EL.charRole.textContent = character.role;
    EL.charBio.textContent = character.bio;
    EL.charMotive.textContent = character.motive;
    EL.charSecret.textContent = character.secret;
    EL.charClue.textContent = character.clue;
    EL.charDrink.textContent = character.drinkingCue;
    EL.charSuperpower.textContent = character.superpower;
    EL.charTask.textContent = character.missionTask;
    const story = buildInviteSynopsis(character);
    EL.storySynopsis1.textContent = story.p1;
    EL.storySynopsis2.textContent = story.p2;
  }

  function getRsvpActionUrl() {
    if (CONFIG.rsvpFormActionUrl && !CONFIG.rsvpFormActionUrl.includes('REPLACE_FORM_ID')) {
      return CONFIG.rsvpFormActionUrl;
    }
    if (CONFIG.rsvpFormUrl && CONFIG.rsvpFormUrl.includes('/viewform')) {
      return CONFIG.rsvpFormUrl.replace('/viewform', '/formResponse');
    }
    return '';
  }

  function buildRsvpUrl() {
    if (!CONFIG.rsvpFormUrl || CONFIG.rsvpFormUrl.includes('REPLACE_FORM_ID')) {
      return '#';
    }

    const url = new URL(CONFIG.rsvpFormUrl);
    const fields = CONFIG.rsvpFields || {};
    if (fields.name) url.searchParams.set(fields.name, lastCharacter ? lastCharacter.displayName : profile.name);
    if (fields.role) url.searchParams.set(fields.role, lastCharacter ? lastCharacter.role : 'Guest');
    if (fields.alias) url.searchParams.set(fields.alias, lastCharacter ? lastCharacter.alias : '');
    if (fields.attendance) url.searchParams.set(fields.attendance, EL.rsvpStatus.value || CONFIG.attendanceYesValue || 'Yes');
    if (fields.eta) url.searchParams.set(fields.eta, EL.rsvpEta.value.trim());
    if (fields.superpower && lastCharacter) url.searchParams.set(fields.superpower, lastCharacter.superpower);
    if (fields.task && lastCharacter) url.searchParams.set(fields.task, lastCharacter.missionTask);
    return url.toString();
  }

  function buildRsvpPayload() {
    const fields = CONFIG.rsvpFields || {};
    const payload = {};
    if (fields.name) payload[fields.name] = lastCharacter ? lastCharacter.displayName : profile.name;
    if (fields.role) payload[fields.role] = lastCharacter ? lastCharacter.role : 'Guest';
    if (fields.alias) payload[fields.alias] = lastCharacter ? lastCharacter.alias : '';
    if (fields.attendance) payload[fields.attendance] = EL.rsvpStatus.value || CONFIG.attendanceYesValue || 'Yes';
    if (fields.eta) payload[fields.eta] = EL.rsvpEta.value.trim();
    if (fields.superpower) payload[fields.superpower] = lastCharacter ? lastCharacter.superpower : '';
    if (fields.task) payload[fields.task] = lastCharacter ? lastCharacter.missionTask : '';
    return payload;
  }

  function cacheRsvpLocally(payload) {
    try {
      const key = 'grove_rsvp_cache';
      const existing = JSON.parse(localStorage.getItem(key) || '[]');
      existing.push({ ts: new Date().toISOString(), payload });
      localStorage.setItem(key, JSON.stringify(existing));
    } catch (err) {
      // ignore local cache errors
    }
  }

  async function submitRsvpToSheet() {
    if (!lastCharacter) {
      setError(EL.apiError, 'Unlock your character first, then submit RSVP.');
      return;
    }

    const actionUrl = getRsvpActionUrl();
    const payload = buildRsvpPayload();
    cacheRsvpLocally(payload);

    if (!actionUrl || actionUrl.includes('REPLACE_FORM_ID')) {
      setError(EL.apiError, 'Set rsvpFormUrl and rsvpFormActionUrl in site-config.js first.');
      return;
    }

    try {
      await fetch(actionUrl, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        body: new URLSearchParams(payload).toString()
      });
      setError(EL.apiError, '');
      setOk(EL.rsvpNote, 'RSVP submitted to sheet. If network is flaky, use RSVP Now as backup.');
    } catch (err) {
      setError(EL.apiError, 'Could not submit directly. Use RSVP Now and submit in the opened form.');
    }
  }

  async function loadCharacter() {
    setError(EL.apiError, '');
    setOk(EL.rsvpNote, '');

    const msgs = [
      'Matching your name against the guest roster',
      'Assigning your corporate superpower',
      'Writing your live mission task',
      'Sealing dossier for game night'
    ];

    let i = 0;
    EL.loadingMsg.textContent = msgs[i];
    const timer = setInterval(() => {
      i = (i + 1) % msgs.length;
      EL.loadingMsg.textContent = msgs[i];
    }, 1200);

    await new Promise((resolve) => setTimeout(resolve, 1200));
    const character = buildMappedCharacter(shuffleOffset);
    lastCharacter = character;
    renderCharacter(character);

    const rsvpUrl = buildRsvpUrl();
    EL.rsvpBtn.href = rsvpUrl;
    EL.rsvpBtn.style.pointerEvents = rsvpUrl === '#' ? 'none' : 'auto';
    EL.rsvpBtn.style.opacity = rsvpUrl === '#' ? '0.55' : '1';

    if (rsvpUrl === '#') {
      setError(EL.apiError, 'Set your RSVP form details in site-config.js to enable submission.');
    } else {
      setOk(EL.rsvpNote, 'Character mapped. RSVP link is prefilled. Direct sheet submit is also available.');
    }

    clearInterval(timer);
    showScreen('character');
  }

  EL.regenBtn.addEventListener('click', async () => {
    shuffleOffset += 17;
    showScreen('loading');
    await loadCharacter();
  });

  EL.rsvpSubmitBtn.addEventListener('click', submitRsvpToSheet);
  EL.rsvpStatus.addEventListener('change', () => {
    if (lastCharacter) EL.rsvpBtn.href = buildRsvpUrl();
  });
  EL.rsvpEta.addEventListener('input', () => {
    if (lastCharacter) EL.rsvpBtn.href = buildRsvpUrl();
  });

  EL.replayBtn.addEventListener('click', () => {
    resetGame();
    showScreen('game');
  });

  resetGame();
</script>
</body>
</html>
