<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>The Grove Incident | Invite Unlock</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Instrument+Serif:ital@0;1&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  :root {
    --bg-1: #0f1216;
    --bg-2: #1e1b17;
    --ink: #efe3c5;
    --ink-dim: #a58f68;
    --gold: #e4b85f;
    --gold-strong: #f2c76b;
    --line: #3a3021;
    --danger: #b04f4f;
    --ok: #7ab78a;
  }

  html, body {
    min-height: 100%;
    background: radial-gradient(circle at 15% 15%, #2a2417 0%, transparent 45%),
      radial-gradient(circle at 80% 70%, #182129 0%, transparent 50%),
      linear-gradient(150deg, var(--bg-1), var(--bg-2));
    color: var(--ink);
    font-family: 'Space Grotesk', sans-serif;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    pointer-events: none;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 250 250' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='0.9' numOctaves='2'/%3E%3C/filter%3E%3Crect width='250' height='250' filter='url(%23n)' opacity='0.06'/%3E%3C/svg%3E");
    opacity: 0.5;
  }

  .wrap {
    width: min(860px, 92vw);
    margin: 0 auto;
    padding: 24px 0 42px;
  }

  .screen {
    display: none;
    animation: rise 0.45s ease both;
  }

  .screen.active {
    display: block;
  }

  .panel {
    background: rgba(12, 14, 18, 0.82);
    border: 1px solid var(--line);
    padding: 28px;
    position: relative;
    backdrop-filter: blur(4px);
  }

  .panel::before {
    content: '';
    position: absolute;
    inset: 10px;
    border: 1px solid rgba(228, 184, 95, 0.12);
    pointer-events: none;
  }

  .eyebrow {
    font-size: 11px;
    letter-spacing: 0.2em;
    color: var(--ink-dim);
    text-transform: uppercase;
  }

  .title {
    margin-top: 10px;
    font-family: 'Bebas Neue', sans-serif;
    letter-spacing: 0.03em;
    font-size: clamp(48px, 12vw, 96px);
    line-height: 0.9;
    color: var(--gold-strong);
  }

  .subtitle {
    margin-top: 4px;
    font-family: 'Instrument Serif', serif;
    font-style: italic;
    font-size: clamp(24px, 4vw, 36px);
    color: var(--ink);
  }

  .body-copy {
    margin-top: 24px;
    font-size: 16px;
    line-height: 1.75;
    color: #cfbf9d;
    max-width: 650px;
  }

  .grid {
    margin-top: 24px;
    display: grid;
    gap: 14px;
  }

  .grid.two {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  label {
    display: block;
    font-size: 11px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--ink-dim);
    margin-bottom: 8px;
  }

  input, select, textarea {
    width: 100%;
    border: 1px solid #4a3e2b;
    background: rgba(5, 6, 8, 0.9);
    color: var(--ink);
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    font-family: 'Space Grotesk', sans-serif;
    outline: none;
  }

  textarea {
    min-height: 90px;
    resize: vertical;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--gold);
    box-shadow: 0 0 0 2px rgba(228, 184, 95, 0.15);
  }

  .actions {
    margin-top: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  button, .btn-link {
    appearance: none;
    border: 1px solid var(--gold);
    background: var(--gold);
    color: #111;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 12px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-weight: 700;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  button.ghost, .btn-link.ghost {
    background: transparent;
    color: var(--gold);
  }

  .note {
    margin-top: 12px;
    font-size: 13px;
    color: var(--ink-dim);
    line-height: 1.6;
  }

  .error {
    margin-top: 12px;
    color: var(--danger);
    font-size: 13px;
    display: none;
  }

  .ok {
    margin-top: 12px;
    color: var(--ok);
    font-size: 13px;
    display: none;
  }

  .game-shell {
    margin-top: 22px;
    border: 1px solid #3d3122;
    border-radius: 12px;
    overflow: hidden;
    background: #090a0c;
  }

  .game-hud {
    display: flex;
    justify-content: space-between;
    padding: 10px 14px;
    background: #141920;
    border-bottom: 1px solid #2f3a4b;
    font-size: 12px;
    color: #d2c19f;
  }

  canvas {
    display: block;
    width: 100%;
    height: auto;
    background: linear-gradient(180deg, #1a1f28, #11161d 55%, #1d1914 55%, #1a120a);
    touch-action: manipulation;
  }

  .game-help {
    padding: 12px 14px;
    border-top: 1px solid #2c261d;
    font-size: 13px;
    color: #bfa67b;
  }

  .status {
    margin-top: 14px;
    min-height: 22px;
    font-size: 14px;
    color: #d3c4a3;
  }

  .dossier {
    margin-top: 22px;
    border: 1px solid #3f3425;
    padding: 22px;
    background: #111319;
  }

  .dossier-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(40px, 7vw, 64px);
    line-height: 0.92;
    color: var(--gold-strong);
    letter-spacing: 0.03em;
  }

  .dossier-sub {
    margin-top: 6px;
    font-family: 'Instrument Serif', serif;
    font-style: italic;
    color: #d7c7a4;
    font-size: 22px;
  }

  .meta {
    margin-top: 8px;
    color: #9f8b67;
    font-size: 14px;
  }

  .card-grid {
    margin-top: 20px;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
  }

  .card {
    border: 1px solid #3a2f20;
    background: rgba(228, 184, 95, 0.05);
    padding: 14px;
  }

  .card h4 {
    font-size: 11px;
    letter-spacing: 0.14em;
    color: #d2b06b;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .card p {
    font-size: 14px;
    line-height: 1.6;
    color: #e5d6b7;
  }

  .event-strip {
    margin-top: 18px;
    border: 1px solid #332a1e;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 1px;
    background: #302619;
  }

  .event-cell {
    background: #121317;
    padding: 12px;
  }

  .event-cell .k {
    font-size: 11px;
    letter-spacing: 0.12em;
    color: #987f57;
    text-transform: uppercase;
  }

  .event-cell .v {
    margin-top: 4px;
    color: #f0e0bf;
    line-height: 1.55;
    font-size: 14px;
  }

  .loader {
    margin-top: 28px;
    text-align: center;
  }

  .dots {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 14px;
  }

  .dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--gold);
    animation: pulse 1.2s infinite ease;
  }

  .dots span:nth-child(2) { animation-delay: 0.15s; }
  .dots span:nth-child(3) { animation-delay: 0.3s; }

  @keyframes pulse {
    0%, 100% { transform: scale(0.75); opacity: 0.35; }
    50% { transform: scale(1); opacity: 1; }
  }

  @keyframes rise {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 760px) {
    .panel { padding: 20px; }
    .grid.two, .card-grid, .event-strip { grid-template-columns: 1fr; }
    .title { font-size: clamp(52px, 18vw, 82px); }
    .subtitle { font-size: 26px; }
  }
</style>
</head>
<body>
<div class="wrap">

  <section id="screen-landing" class="screen active">
    <div class="panel">
      <div class="eyebrow">Confidential Invite • The Grove A7</div>
      <h1 class="title">THE GROVE</h1>
      <div class="subtitle">Signal & Noise</div>
      <p class="body-copy">
        This invite is interactive. Your dossier only unlocks if you finish a short 27-year run:
        nursery, school, exams, college, jobs, deadlines, and rent. Survive to age 27 and the case file opens.
      </p>
      <div class="actions">
        <button id="start-btn">Start Invite Unlock</button>
      </div>
      <p class="note">Party date: Sunday, 1 March 2026 • Doors 5:00 PM • Story begins 8:00 PM</p>
    </div>
  </section>

  <section id="screen-profile" class="screen">
    <div class="panel">
      <div class="eyebrow">Step 1 • Identity</div>
      <h2 class="subtitle">Build your profile before the game</h2>

      <div class="grid two">
        <div>
          <label for="name-input">Name *</label>
          <input id="name-input" type="text" placeholder="Your name" autocomplete="name" />
        </div>
        <div>
          <label for="title-input">Current role/title *</label>
          <input id="title-input" type="text" placeholder="Product, Data, Design, Founder, etc" />
        </div>
      </div>

      <div class="grid two">
        <div>
          <label for="vibe-input">Party vibe</label>
          <select id="vibe-input">
            <option value="balanced">Balanced floors</option>
            <option value="anthem">Lower hall anthem energy</option>
            <option value="after-hours">Upper hall after-hours run</option>
            <option value="floating">I will floor-hop all night</option>
          </select>
        </div>
        <div>
          <label for="trait-input">Your known trait</label>
          <input id="trait-input" type="text" placeholder="Example: analytical, chaotic, storyteller" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="lore-input">One line from your life story</label>
          <textarea id="lore-input" placeholder="Example: Survived CAT prep, startup pivots, and 3 toxic deadlines."></textarea>
        </div>
      </div>

      <div class="actions">
        <button id="to-game-btn">Continue to Unlock Game</button>
        <button class="ghost" id="back-to-landing-btn">Back</button>
      </div>
      <p class="error" id="profile-error"></p>
    </div>
  </section>

  <section id="screen-game" class="screen">
    <div class="panel">
      <div class="eyebrow">Step 2 • Unlock Run</div>
      <h2 class="subtitle">Age Runner: Reach 27</h2>
      <p class="note">Desktop: `Space` to jump. Mobile: tap the game area. Hit an obstacle and restart.</p>

      <div class="game-shell">
        <div class="game-hud">
          <span id="hud-age">Age: 0</span>
          <span id="hud-distance">Progress: 0%</span>
          <span id="hud-stage">Stage: Nursery</span>
        </div>
        <canvas id="runner-canvas" width="760" height="240"></canvas>
        <div class="game-help">Obstacles are life checkpoints: nursery, boards, entrances, placements, appraisals, and weekend deploys.</div>
      </div>

      <div class="status" id="game-status">Press start when ready.</div>
      <div class="actions">
        <button id="game-start-btn">Start Run</button>
        <button class="ghost" id="game-reset-btn">Reset</button>
        <button class="ghost" id="game-back-btn">Edit Profile</button>
      </div>
    </div>
  </section>

  <section id="screen-loading" class="screen">
    <div class="panel loader">
      <div class="eyebrow">Step 3 • AI Dossier</div>
      <h2 class="subtitle">Generating your character card...</h2>
      <p class="note" id="loading-msg">Contacting case archives</p>
      <div class="dots"><span></span><span></span><span></span></div>
    </div>
  </section>

  <section id="screen-character" class="screen">
    <div class="panel">
      <div class="eyebrow">Unlocked • Invitee Dossier</div>
      <div class="dossier">
        <h2 class="dossier-title" id="char-alias">The Placeholder</h2>
        <div class="dossier-sub" id="char-name">Name</div>
        <div class="meta" id="char-role">Role</div>

        <div class="card-grid">
          <div class="card">
            <h4>Bio</h4>
            <p id="char-bio"></p>
          </div>
          <div class="card">
            <h4>Motive</h4>
            <p id="char-motive"></p>
          </div>
          <div class="card">
            <h4>Secret</h4>
            <p id="char-secret"></p>
          </div>
          <div class="card">
            <h4>Clue</h4>
            <p id="char-clue"></p>
          </div>
        </div>

        <div class="card" style="margin-top: 12px;">
          <h4>Drinking Cue</h4>
          <p id="char-drink"></p>
        </div>

        <div class="event-strip">
          <div class="event-cell">
            <div class="k">Date</div>
            <div class="v">Sunday, 1 March 2026</div>
          </div>
          <div class="event-cell">
            <div class="k">Doors</div>
            <div class="v">5:00 PM</div>
          </div>
          <div class="event-cell">
            <div class="k">Story Time</div>
            <div class="v">8:00 PM sharp</div>
          </div>
          <div class="event-cell">
            <div class="k">Venue</div>
            <div class="v">The Grove, A7, Sarjapur Road</div>
          </div>
          <div class="event-cell">
            <div class="k">Lower Hall</div>
            <div class="v">House Pot & Bar</div>
          </div>
          <div class="event-cell">
            <div class="k">Upper Hall</div>
            <div class="v">After Hours Hall</div>
          </div>
        </div>
      </div>

      <div class="actions">
        <a id="rsvp-btn" class="btn-link" target="_blank" rel="noopener noreferrer">RSVP Now</a>
        <button class="ghost" id="regen-btn">Regenerate Character</button>
        <button class="ghost" id="replay-btn">Replay Unlock</button>
      </div>
      <p class="note">House setup is available. BYOB is appreciated, especially after 8 PM.</p>
      <p class="error" id="api-error"></p>
      <p class="ok" id="rsvp-note">RSVP link ready. Your name and role are prefilled.</p>
    </div>
  </section>

</div>

<script src="./site-config.js"></script>
<script>
  // Override these in production by setting window.APP_CONFIG before this script.
  const DEFAULT_CONFIG = {
    apiUrl: "https://REPLACE_WITH_YOUR_WORKER_URL/api/character",
    rsvpFormUrl: "https://docs.google.com/forms/d/e/REPLACE_FORM_ID/viewform",
    rsvpFields: {
      name: "entry.111111111",
      role: "entry.222222222",
      alias: "entry.333333333",
      attendance: "entry.444444444"
    },
    attendanceYesValue: "Yes"
  };

  const CONFIG = Object.assign({}, DEFAULT_CONFIG, window.APP_CONFIG || {});

  const PRIORITY_CONTEXT = {
    "bharat dhir": { title: "Category Manager", trait: "social" },
    "manasi chansoria": { title: "Assistant Manager", trait: "energetic" },
    "ayush mittal": { title: "Data Engineer", trait: "shy" },
    "shikhar sharma": { title: "Data Scientist", trait: "charismatic" },
    "shubh khandelwal": { title: "Product Lead", trait: "smart" },
    "gunjan samtani": { title: "Product Manager", trait: "social" },
    "kartik khandelwal": { title: "Product Manager", trait: "proud" },
    "pooja ghatia": { title: "Product Manager", trait: "fun" },
    "aniket chandra": { title: "Finance", trait: "gym bro" },
    "vaibhav gupta": { title: "Tech", trait: "philosophical" },
    "varun chopra": { title: "Product Manager", trait: "boxing" },
    "pranjal srivastava": { title: "Singer", trait: "musician" },
    "aanak sengupta": { title: "Product Manager", trait: "traveler" },
    "siddak bakshi": { title: "Crypto", trait: "founder" },
    "neil daftary": { title: "Crypto", trait: "deep thinker" },
    "devashish rane": { title: "Product Manager", trait: "charismatic" },
    "ritvik hedge": { title: "Product Manager", trait: "board game strategist" },
    "harsh bhimrajka": { title: "Security Tech", trait: "friendly" },
    "sajag jain": { title: "Business Analyst", trait: "detail-oriented" },
    "ayush borse": { title: "Product Manager", trait: "fixer" },
    "aiswarya mahajan": { title: "Designer", trait: "artist" },
    "naren kashyap": { title: "Founder + DJ", trait: "hype" },
    "shubham jain": { title: "Data Scientist", trait: "sports nerd" },
    "kovid poudel": { title: "Product + Tech", trait: "talented" }
  };

  const EL = {
    screens: {
      landing: document.getElementById('screen-landing'),
      profile: document.getElementById('screen-profile'),
      game: document.getElementById('screen-game'),
      loading: document.getElementById('screen-loading'),
      character: document.getElementById('screen-character')
    },
    startBtn: document.getElementById('start-btn'),
    toGameBtn: document.getElementById('to-game-btn'),
    backToLandingBtn: document.getElementById('back-to-landing-btn'),
    profileError: document.getElementById('profile-error'),
    nameInput: document.getElementById('name-input'),
    titleInput: document.getElementById('title-input'),
    vibeInput: document.getElementById('vibe-input'),
    traitInput: document.getElementById('trait-input'),
    loreInput: document.getElementById('lore-input'),
    gameStartBtn: document.getElementById('game-start-btn'),
    gameResetBtn: document.getElementById('game-reset-btn'),
    gameBackBtn: document.getElementById('game-back-btn'),
    gameStatus: document.getElementById('game-status'),
    hudAge: document.getElementById('hud-age'),
    hudDistance: document.getElementById('hud-distance'),
    hudStage: document.getElementById('hud-stage'),
    loadingMsg: document.getElementById('loading-msg'),
    charAlias: document.getElementById('char-alias'),
    charName: document.getElementById('char-name'),
    charRole: document.getElementById('char-role'),
    charBio: document.getElementById('char-bio'),
    charMotive: document.getElementById('char-motive'),
    charSecret: document.getElementById('char-secret'),
    charClue: document.getElementById('char-clue'),
    charDrink: document.getElementById('char-drink'),
    apiError: document.getElementById('api-error'),
    rsvpBtn: document.getElementById('rsvp-btn'),
    rsvpNote: document.getElementById('rsvp-note'),
    regenBtn: document.getElementById('regen-btn'),
    replayBtn: document.getElementById('replay-btn')
  };

  const profile = {
    name: "",
    title: "",
    vibe: "",
    trait: "",
    lore: ""
  };

  let lastCharacter = null;

  function showScreen(name) {
    Object.values(EL.screens).forEach((s) => s.classList.remove('active'));
    EL.screens[name].classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function setError(el, message) {
    el.textContent = message || '';
    el.style.display = message ? 'block' : 'none';
  }

  function setOk(el, message) {
    el.textContent = message || '';
    el.style.display = message ? 'block' : 'none';
  }

  function readProfile() {
    profile.name = EL.nameInput.value.trim();
    profile.title = EL.titleInput.value.trim();
    profile.vibe = EL.vibeInput.value;
    profile.trait = EL.traitInput.value.trim();
    profile.lore = EL.loreInput.value.trim();
  }

  function validateProfile() {
    if (!profile.name || profile.name.length < 2) return 'Enter your name.';
    if (!profile.title || profile.title.length < 2) return 'Enter your role/title.';
    return '';
  }

  EL.startBtn.addEventListener('click', () => showScreen('profile'));
  EL.backToLandingBtn.addEventListener('click', () => showScreen('landing'));

  EL.toGameBtn.addEventListener('click', () => {
    readProfile();
    const err = validateProfile();
    setError(EL.profileError, err);
    if (err) return;
    showScreen('game');
  });

  // -------------------------
  // Age Runner mini game
  // -------------------------
  const canvas = document.getElementById('runner-canvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width;
  const H = canvas.height;
  const GROUND = 184;

  const STAGES = [
    { age: 0, label: 'Nursery' },
    { age: 4, label: 'School' },
    { age: 10, label: 'Boards' },
    { age: 16, label: 'Entrances' },
    { age: 19, label: 'College' },
    { age: 22, label: 'Placements' },
    { age: 25, label: 'Corporate' },
    { age: 27, label: 'Birthday Eve' }
  ];

  const OBSTACLE_POOL = [
    'Nursery Admission',
    'Homework Pile',
    'Board Exams',
    'Coaching Burnout',
    'Entrance Rank',
    'Attendance Shortage',
    'Semester Backlog',
    'Placement Season',
    'Probation Review',
    'Deadline Friday',
    'Reorg Surprise',
    'Rent Due',
    'Family Group Call',
    'Weekend Deploy',
    'Tax Reminder'
  ];

  const game = {
    running: false,
    won: false,
    age: 0,
    progress: 0,
    distance: 0,
    speed: 4.2,
    gravity: 0.68,
    jumpVelocity: -11.6,
    frame: 0,
    nextSpawnFrame: 70,
    player: {
      x: 80,
      y: GROUND,
      width: 22,
      height: 32,
      vy: 0,
      onGround: true
    },
    obstacles: []
  };

  function currentStage(age) {
    let stage = STAGES[0].label;
    for (let i = 0; i < STAGES.length; i += 1) {
      if (age >= STAGES[i].age) stage = STAGES[i].label;
    }
    return stage;
  }

  function resetGame() {
    game.running = false;
    game.won = false;
    game.age = 0;
    game.progress = 0;
    game.distance = 0;
    game.frame = 0;
    game.nextSpawnFrame = 70;
    game.player.y = GROUND;
    game.player.vy = 0;
    game.player.onGround = true;
    game.obstacles = [];
    updateHUD();
    drawFrame();
    EL.gameStatus.textContent = 'Press start when ready.';
  }

  function jump() {
    if (!game.running) return;
    if (game.player.onGround) {
      game.player.vy = game.jumpVelocity;
      game.player.onGround = false;
    }
  }

  function spawnObstacle() {
    const label = OBSTACLE_POOL[Math.floor(Math.random() * OBSTACLE_POOL.length)];
    const width = 52 + Math.floor(Math.random() * 26);
    const height = 26 + Math.floor(Math.random() * 38);
    game.obstacles.push({
      x: W + 14,
      y: GROUND - height,
      width,
      height,
      label
    });
    game.nextSpawnFrame = 54 + Math.floor(Math.random() * 46);
  }

  function collides(a, b) {
    return (
      a.x < b.x + b.width &&
      a.x + a.width > b.x &&
      a.y < b.y + b.height &&
      a.y + a.height > b.y
    );
  }

  function updateHUD() {
    EL.hudAge.textContent = `Age: ${game.age}`;
    EL.hudDistance.textContent = `Progress: ${Math.min(100, Math.floor(game.progress * 100))}%`;
    EL.hudStage.textContent = `Stage: ${currentStage(game.age)}`;
  }

  function drawPlayer() {
    ctx.fillStyle = '#f6c66b';
    ctx.fillRect(game.player.x, game.player.y - game.player.height, game.player.width, game.player.height);

    ctx.fillStyle = '#1a1207';
    ctx.fillRect(game.player.x + 6, game.player.y - game.player.height + 8, 3, 3);

    const ageScale = 0.6 + Math.min(0.7, game.age / 27);
    const headR = 6 * ageScale;
    ctx.beginPath();
    ctx.arc(game.player.x + game.player.width / 2, game.player.y - game.player.height - headR + 2, headR, 0, Math.PI * 2);
    ctx.fillStyle = '#e6d7b6';
    ctx.fill();
  }

  function drawObstacle(o) {
    ctx.fillStyle = '#8d4f4f';
    ctx.fillRect(o.x, o.y, o.width, o.height);
    ctx.fillStyle = '#f7d7d7';
    ctx.font = '11px Space Grotesk';
    ctx.fillText(o.label, o.x + 4, o.y - 6);
  }

  function drawBackground() {
    ctx.clearRect(0, 0, W, H);

    ctx.fillStyle = '#a7895b';
    ctx.fillRect(0, GROUND + 1, W, 2);

    ctx.fillStyle = 'rgba(255,255,255,0.04)';
    for (let i = 0; i < 24; i += 1) {
      const x = (i * 45 + (game.frame * 0.5) % 45) % W;
      ctx.fillRect(x, GROUND + 6, 14, 2);
    }
  }

  function drawFrame() {
    drawBackground();
    game.obstacles.forEach(drawObstacle);
    drawPlayer();
  }

  function failRun(hit) {
    game.running = false;
    EL.gameStatus.textContent = `Hit: ${hit.label}. Reset and try again.`;
  }

  async function winRun() {
    game.running = false;
    game.won = true;
    EL.gameStatus.textContent = 'Unlocked. Building your dossier...';
    showScreen('loading');
    await loadCharacter();
  }

  function tick() {
    if (!game.running) return;

    game.frame += 1;
    game.distance += game.speed;
    game.progress = Math.min(1, game.distance / 3900);
    game.age = Math.min(27, Math.floor(game.progress * 27));

    game.player.vy += game.gravity;
    game.player.y += game.player.vy;

    if (game.player.y >= GROUND) {
      game.player.y = GROUND;
      game.player.vy = 0;
      game.player.onGround = true;
    }

    if (game.frame >= game.nextSpawnFrame) {
      spawnObstacle();
      game.frame = 0;
    }

    for (let i = game.obstacles.length - 1; i >= 0; i -= 1) {
      const o = game.obstacles[i];
      o.x -= game.speed;
      if (o.x + o.width < -10) {
        game.obstacles.splice(i, 1);
        continue;
      }
      const boxPlayer = {
        x: game.player.x,
        y: game.player.y - game.player.height,
        width: game.player.width,
        height: game.player.height
      };
      if (collides(boxPlayer, o)) {
        failRun(o);
      }
    }

    updateHUD();
    drawFrame();

    if (game.running && game.age >= 27) {
      winRun();
      return;
    }

    requestAnimationFrame(tick);
  }

  EL.gameStartBtn.addEventListener('click', () => {
    if (game.running) return;
    if (game.won) resetGame();
    readProfile();
    const err = validateProfile();
    if (err) {
      setError(EL.profileError, err);
      showScreen('profile');
      return;
    }
    game.running = true;
    EL.gameStatus.textContent = 'Run started. Jump over every life obstacle.';
    requestAnimationFrame(tick);
  });

  EL.gameResetBtn.addEventListener('click', resetGame);
  EL.gameBackBtn.addEventListener('click', () => showScreen('profile'));

  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
      e.preventDefault();
      jump();
    }
  });

  canvas.addEventListener('pointerdown', jump);

  // -------------------------
  // Character generation
  // -------------------------
  function buildPayload() {
    const key = profile.name.toLowerCase().trim();
    const known = PRIORITY_CONTEXT[key] || null;
    return {
      name: profile.name,
      title: profile.title,
      vibe: profile.vibe,
      trait: profile.trait || (known ? known.trait : ''),
      lore: profile.lore,
      knownContext: known,
      partyContext: {
        location: 'The Grove A7',
        date: 'Sunday, 1 March 2026',
        event: 'Birthday + mystery game'
      }
    };
  }

  function fallbackCharacter() {
    return {
      alias: 'The Last-Minute Legend',
      role: `${profile.title} - Unverified Witness`,
      bio: `${profile.name} arrived with suspiciously perfect timing and immediately understood the room dynamic.`,
      motive: 'They suspect someone rewrote the story of what happened at the original launch party and want leverage before midnight.',
      secret: 'They have one screenshot that can flip the main accusation, but are waiting for maximum impact.',
      clue: 'A phone note tagged "draft-not-for-board" with a timestamp that does not match public records.',
      drinkingCue: 'Drink every time someone says "alignment" without naming a metric.'
    };
  }

  function normalizeCharacter(raw) {
    const char = Object.assign({}, fallbackCharacter(), raw || {});
    return {
      alias: String(char.alias || '').trim() || 'The Last-Minute Legend',
      role: String(char.role || '').trim() || `${profile.title} - Unverified Witness`,
      bio: String(char.bio || '').trim(),
      motive: String(char.motive || '').trim(),
      secret: String(char.secret || '').trim(),
      clue: String(char.clue || '').trim(),
      drinkingCue: String(char.drinkingCue || '').trim()
    };
  }

  async function generateCharacter() {
    const payload = buildPayload();

    if (!CONFIG.apiUrl || CONFIG.apiUrl.includes('REPLACE_WITH_YOUR_WORKER_URL')) {
      throw new Error('API URL is not configured yet.');
    }

    const res = await fetch(CONFIG.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(`API error ${res.status}: ${text.slice(0, 120)}`);
    }

    const data = await res.json();
    return normalizeCharacter(data.character || data);
  }

  function renderCharacter(character) {
    EL.charAlias.textContent = character.alias;
    EL.charName.textContent = profile.name;
    EL.charRole.textContent = character.role;
    EL.charBio.textContent = character.bio;
    EL.charMotive.textContent = character.motive;
    EL.charSecret.textContent = character.secret;
    EL.charClue.textContent = character.clue;
    EL.charDrink.textContent = character.drinkingCue;
  }

  function buildRsvpUrl() {
    if (!CONFIG.rsvpFormUrl || CONFIG.rsvpFormUrl.includes('REPLACE_FORM_ID')) {
      return '#';
    }

    const url = new URL(CONFIG.rsvpFormUrl);
    const fields = CONFIG.rsvpFields || {};
    if (fields.name) url.searchParams.set(fields.name, profile.name);
    if (fields.role) url.searchParams.set(fields.role, lastCharacter ? lastCharacter.role : profile.title);
    if (fields.alias) url.searchParams.set(fields.alias, lastCharacter ? lastCharacter.alias : '');
    if (fields.attendance) url.searchParams.set(fields.attendance, CONFIG.attendanceYesValue || 'Yes');
    return url.toString();
  }

  async function loadCharacter() {
    setError(EL.apiError, '');
    setOk(EL.rsvpNote, '');

    const msgs = [
      'Cross-checking launch archives',
      'Correlating model logs and wallet traces',
      'Building your dossier file',
      'Applying narrative risk scoring'
    ];

    let i = 0;
    EL.loadingMsg.textContent = msgs[i];
    const timer = setInterval(() => {
      i = (i + 1) % msgs.length;
      EL.loadingMsg.textContent = msgs[i];
    }, 1200);

    try {
      const character = await generateCharacter();
      lastCharacter = character;
      renderCharacter(character);

      const rsvpUrl = buildRsvpUrl();
      EL.rsvpBtn.href = rsvpUrl;
      EL.rsvpBtn.style.pointerEvents = rsvpUrl === '#' ? 'none' : 'auto';
      EL.rsvpBtn.style.opacity = rsvpUrl === '#' ? '0.55' : '1';

      if (rsvpUrl === '#') {
        setError(EL.apiError, 'Set your RSVP form URL in APP_CONFIG to enable RSVP.');
      } else {
        setOk(EL.rsvpNote, 'RSVP link ready. Your name and role are prefilled.');
      }

      showScreen('character');
    } catch (err) {
      lastCharacter = fallbackCharacter();
      renderCharacter(lastCharacter);
      EL.rsvpBtn.href = buildRsvpUrl();
      setError(EL.apiError, `AI unavailable: ${err.message}. Using fallback character.`);
      showScreen('character');
    } finally {
      clearInterval(timer);
    }
  }

  EL.regenBtn.addEventListener('click', async () => {
    showScreen('loading');
    await loadCharacter();
  });

  EL.replayBtn.addEventListener('click', () => {
    resetGame();
    showScreen('game');
  });

  resetGame();
</script>
</body>
</html>
